<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Pedidos y Gesti√≥n - Mercado Libre</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        header { margin-bottom: 15px; text-align: center; }
        header h1 { color: #2c3e50; font-weight: 600;}
        nav { margin-bottom: 25px; border-bottom: 2px solid #3498db; padding-bottom: 12px; text-align: center; flex-wrap: wrap; display: flex; justify-content: center;}
        nav button {
            padding: 10px 18px; margin: 5px 6px; cursor: pointer; background-color: #3498db;
            color: white; border: none; border-radius: 5px; font-size: 0.95em; font-weight: 500;
            transition: background-color 0.2s ease;
        }
        nav button:hover { background-color: #2980b9; }
        .container { max-width: 1000px; margin: auto; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
        th, td { border: 1px solid #dfe6e9; padding: 12px; text-align: left; vertical-align: top; }
        th { background-color: #eaf2f8; color: #34495e; font-weight: 600; }
        td img { vertical-align: middle; margin-right: 5px; max-width: 50px; max-height:50px; border-radius:3px; }
        .scan-input { padding: 10px; margin-bottom: 20px; box-sizing: border-box; border: 1px solid #b2bec3; border-radius: 4px; width: calc(100% - 24px); }
        .action-button { padding: 8px 14px; cursor: pointer; background-color: #5dade2; color: white; border: none; border-radius: 4px; margin-right: 6px; font-size:0.9em; }
        .action-button:hover { background-color: #3498db; }
        .action-button-secondary { background-color: #7f8c8d; }
        .action-button-secondary:hover { background-color: #6c7a89; }
        .action-button-danger { background-color: #e74c3c; }
        .action-button-danger:hover { background-color: #c0392b; }
        .action-button-warning { background-color: #f39c12; }
        .action-button-warning:hover { background-color: #e67e22; }
        .action-button-success { background-color: #2ecc71; }
        .action-button-success:hover { background-color: #27ae60; }

        .complete-button { padding: 12px 20px; background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.05em; font-weight: 500;}
        .complete-button:hover { background-color: #27ae60; }
        .complete-button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .order-list-item { padding: 12px 15px; border: 1px solid #ecf0f1; margin-bottom: 10px; cursor: pointer; border-radius: 5px; background-color: #fdfefe; transition: background-color 0.2s ease;}
        .order-list-item:hover { background-color: #e9f5fe; }
        .order-list-item.cancelado-pendiente { background-color: #ffebee !important; border-left: 4px solid #c0392b; }
        .order-list-item strong { color: #2980b9; }
        .section-title { color: #34495e; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; margin-top: 15px; margin-bottom: 20px; font-size: 1.4em; font-weight: 600;}
        #acciones-historial-dia { border-top: 1px dashed #dfe6e9; padding-top: 15px; margin-top:20px;}
       
        #verificacion-actual-wrapper, #historial-pedidos, #preguntas-wrapper, #mensajes-postventa-wrapper, #dashboard-wrapper, #configuracion-wrapper, #devoluciones-wrapper { display: none; }
        #acciones-historial-dia {display: none;}
        #verificacion-pedido {display: none;}

        .categoria-pedidos { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; background-color: #f9f9f9; }
        .categoria-pedidos h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 8px; font-size: 1.2em; }
        .lista-especifica p { font-style: italic; color: #7f8c8d; padding: 10px 0; }

        .pregunta-item, .conversacion-item, .devolucion-item { border: 1px solid #dfe6e9; padding: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #fdfefe; overflow: auto;  position: relative; }
        .pregunta-item strong, .conversacion-item strong, .devolucion-item strong { color: #2c3e50; }
        .pregunta-item img { max-width: 60px; float: left; margin-right: 15px; border: 1px solid #eee; border-radius: 4px;}
        .pregunta-item .pregunta-info { margin-left: 75px; }
        .pregunta-item .pregunta-info p, .conversacion-item p, .devolucion-item p { margin: 5px 0; }
        .pregunta-item .pregunta-texto { font-style: italic; margin-bottom: 8px; }
        .pregunta-item .pregunta-meta, .conversacion-item .conversacion-meta, .devolucion-item .devolucion-meta { font-size: 0.85em; color: #7f8c8d; margin-bottom: 10px; }
        .pregunta-item textarea, .modal-contenido textarea { width: calc(100% - 22px); padding:10px; min-height: 60px; margin-top: 10px; margin-bottom: 10px; border:1px solid #b2bec3; border-radius:4px; box-sizing: border-box;}
       
        .notif-badge { background-color: #e74c3c; color: white; border-radius: 10px; padding: 2px 7px; font-size: 0.75em; margin-left: 5px; display: inline-block; vertical-align: middle; font-weight: bold; line-height: 1; }

        #historial-pedidos label, #configuracion-wrapper label { margin-right: 10px; font-weight:500; }
        #historial-pedidos input[type="date"], #configuracion-wrapper input[type="text"], #configuracion-wrapper select { padding: 8px; border-radius: 4px; border: 1px solid #b2bec3; margin-right:5px; }
        .pedido-historial-item { border: 1px solid #e0e0e0; padding: 15px; margin-top: 15px; border-radius: 6px; background-color: #f9f9f9; }
        .pedido-historial-item.cancelado { background-color: #ffebee !important; border-left: 5px solid #c0392b; } 
        .pedido-historial-item strong { color: #2c3e50; }
        #lista-historial-resultados p, #resumen-productos-dia-resultados p, #lista-conversaciones-postventa p, #lista-preguntas p, #lista-devoluciones-container p {font-style: italic; color: #7f8c8d;}

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-contenido { background-color: #fff; margin: auto; padding: 25px; border: 1px solid #b2bec3; border-radius: 8px; width: 85%; max-width: 650px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dfe6e9; padding-bottom: 10px; margin-bottom: 15px;}
        .modal-header h3 { margin: 0; font-size: 1.3em; color: #2c3e50;}
        .modal-cerrar { cursor: pointer; font-size: 28px; font-weight: bold; color: #7f8c8d;}
        .modal-cerrar:hover { color: #2c3e50; }
        .chat-area { height: 300px; overflow-y: auto; border: 1px solid #dfe6e9; padding: 15px; margin-bottom: 15px; background-color: #f9fafb; border-radius: 4px;}
        .mensaje { margin-bottom: 12px; line-height: 1.4; }
        .mensaje p { display: inline-block; padding: 10px 14px; border-radius: 15px; max-width: 75%; margin: 0;}
        .mensaje-recibido p { background-color: #e9ecef; color: #343a40; border-top-left-radius: 0;}
        .mensaje-enviado { text-align: right; }
        .mensaje-enviado p { background-color: #007bff; color: white; border-top-right-radius: 0;}
        .mensaje-meta { font-size: 0.8em; color: #7f8c8d; display: block; margin-top: 4px; }
        .mensaje-recibido .mensaje-meta { text-align: left; }
        .mensaje-enviado .mensaje-meta { text-align: right; }
        .item-no-leido { font-weight:bold; border-left: 4px solid #e74c3c !important; background-color: #fff3f3 !important;}
        .item-leido { font-weight:normal; border-left: 4px solid #bdc3c7 !important; background-color: #fdfefe !important; }
        .item-leido small, .item-leido .pregunta-meta { font-weight: normal !important; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .dashboard-card { background-color: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-card h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-size: 1.1em; }
        .dashboard-metric { font-size: 2.5em; font-weight: bold; color: #2980b9; margin: 0; }
        .dashboard-card.warning h4 { color: #c0392b; } 
        .dashboard-card.warning .dashboard-metric { color: #e74c3c; }


        .notas-internas-pedido { margin-top: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; background-color: #fdfdff; }
        .notas-internas-pedido h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-size: 1.1em; }
        .notas-internas-pedido textarea { width: calc(100% - 22px); min-height: 70px; padding: 10px; border: 1px solid #b2bec3; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
        .detalle-producto-adicional { font-size: 0.9em; color: #555; }
        .detalle-producto-adicional strong { color: #333; }

        .contenedor-respuesta .select-plantilla { display: block; width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #b2bec3; border-radius: 4px; box-sizing: border-box; background-color: #fff; }
        .pregunta-item .contenedor-respuesta, .modal-contenido .contenedor-respuesta { margin-top: 10px; }
        .item-acciones { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;}
        .item-acciones > * { margin-bottom: 5px; }


        /* Configuraci√≥n Empaquetadores */
        .config-section { margin-bottom: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 6px; background-color: #f9f9f9;}
        .config-section h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 8px;}
        #lista-empaquetadores-actuales { margin-top: 10px; list-style:decimal; padding-left:20px;}
        #lista-empaquetadores-actuales li {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        #lista-empaquetadores-actuales li button {
            margin-left: 15px;
            padding: 4px 8px;
            font-size: 0.85em;
        }
        #empaquetador-activo-info { margin-top: 15px; margin-bottom:15px; padding: 10px; background-color: #eaf2f8; border-radius: 4px; color: #34495e; font-weight: bold; }
        #empaquetador-activo-info.no-seleccionado { background-color: #fadbd8; color: #c0392b;}

        /* Devoluciones */
        .devolucion-productos-lista { list-style: disc; padding-left: 20px; margin-top:5px; }
        .devolucion-productos-lista li { font-size: 0.9em; }
        .devolucion-item .estado-devolucion { font-weight: bold; }
        .estado-Iniciada { color: #3498db; }
        .estado-EnTransitoAlVendedor { color: #f39c12; }
        .estado-RecibidaPorElVendedor { color: #27ae60; }
        .estado-Inspecci√≥nCompletada { color: #16a085; }
        .estado-ProcesadaStockReingresado { color: #2ecc71; }
        .estado-ProcesadaItemsDescartados { color: #e74c3c; }
        .estado-ReembolsoProcesado { color: #2ecc71; }
        .estado-Cerrada { color: #7f8c8d; }
        .estado-Cancelada { color: #c0392b; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Sistema de Verificaci√≥n de Empaques y Gesti√≥n ML</h1></header>
        <nav>
            <button onclick="mostrarSeccion('dashboard-wrapper')">üìä Dashboard</button>
            <button onclick="mostrarSeccion('verificacion-actual-wrapper')">Verificaci√≥n Actual</button>
            <button onclick="mostrarSeccion('preguntas-wrapper')">Preguntas <span id="notif-badge-preguntas" class="notif-badge" style="display:none;">0</span></button>
            <button onclick="mostrarSeccion('mensajes-postventa-wrapper')">Mensajes Post-Venta <span id="notif-badge-postventa" class="notif-badge" style="display:none;">0</span></button>
            <button onclick="mostrarSeccion('devoluciones-wrapper')">‚Ü©Ô∏è Devoluciones</button>
            <button onclick="mostrarSeccion('historial-pedidos')">Historial Pedidos</button>
            <button onclick="mostrarSeccion('configuracion-wrapper')">‚öôÔ∏è Configuraci√≥n</button>
        </nav>

        <!-- Contenido de las secciones -->
        <div id="dashboard-wrapper">
            <h2 class="section-title">üìä Resumen del D√≠a</h2>
             <div id="empaquetador-activo-info" class="no-seleccionado">Empaquetador Activo: Ninguno seleccionado. Por favor, ve a Configuraci√≥n.</div>
            <div class="dashboard-grid">
                <div class="dashboard-card"><h4>Pedidos Empaquetados Hoy (Neto)</h4><p class="dashboard-metric" id="db-pedidos-empaquetados">-</p></div>
                <div class="dashboard-card warning"><h4>‚ö†Ô∏è Cancelados Post-Empaque Hoy</h4><p class="dashboard-metric" id="db-cancelados-post-empaque-hoy">-</p></div>
                <div class="dashboard-card"><h4>Preguntas Pendientes</h4><p class="dashboard-metric" id="db-preguntas-pendientes">-</p></div>
                <div class="dashboard-card"><h4>Mensajes Nuevos</h4><p class="dashboard-metric" id="db-mensajes-nuevos">-</p></div>
                <div class="dashboard-card"><h4>Devoluciones Activas</h4><p class="dashboard-metric" id="db-devoluciones-activas">-</p></div>
                <div class="dashboard-card"><h4>Pedidos TURBO</h4><p class="dashboard-metric" id="db-turbo-pendientes">-</p></div>
                <div class="dashboard-card"><h4>Pedidos FLEX</h4><p class="dashboard-metric" id="db-flex-pendientes">-</p></div>
                <div class="dashboard-card"><h4>üì¨ Pedidos CORREO</h4><p class="dashboard-metric" id="db-correo-pendientes">-</p></div>
                <div class="dashboard-card"><h4>üö∂ Retiros Persona</h4><p class="dashboard-metric" id="db-retiros-pendientes">-</p></div>
                <div class="dashboard-card"><h4>Total Pendientes Empaque</h4><p class="dashboard-metric" id="db-total-pendientes">-</p></div>
            </div>
             <div id="aviso-cancelados-recientes" style="margin-top: 20px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px; display:none;">
                <strong>Atenci√≥n:</strong> Se han detectado pedidos empaquetados previamente que ahora figuran como cancelados. Revisa el historial.
            </div>
        </div>

        <div id="verificacion-actual-wrapper">
             <section id="lista-pedidos">
                <h2 class="section-title">Pedidos Pendientes de Verificaci√≥n</h2>
                <div class="categoria-pedidos" id="cat-turbo"><h3>‚ö° Pedidos TURBO</h3><div id="pedidos-turbo-list" class="lista-especifica"><p>Cargando...</p></div></div>
                <div class="categoria-pedidos" id="cat-flex"><h3>üõµ Pedidos FLEX</h3><div id="pedidos-flex-list" class="lista-especifica"><p>Cargando...</p></div></div>
                <div class="categoria-pedidos" id="cat-correo"><h3>üì¨ Pedidos CORREO</h3><div id="pedidos-correo-list" class="lista-especifica"><p>Cargando...</p></div></div>
                <div class="categoria-pedidos" id="cat-retiro"><h3>üö∂ Pedidos RETIRO EN PERSONA</h3><div id="pedidos-retiro-list" class="lista-especifica"><p>Cargando...</p></div></div>
            </section>
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #dfe6e9;">
            <section id="verificacion-pedido">
                <h2 class="section-title">Verificando Pedido: <span id="id-pedido-actual"></span></h2>
                <div><label for="barcode-scanner" style="font-weight:500; display:block; margin-bottom:5px;">Escanear C√≥digo (SKU):</label><input type="text" id="barcode-scanner" class="scan-input" placeholder="Esperando escaneo..."></div>
                <h3>Productos del Pedido:</h3>
                <table>
                    <thead><tr><th>Imagen</th><th>Nombre</th><th>SKU/Variante</th><th>Ubicaci√≥n/Notas Prod.</th><th>Cant. Pedida</th><th>Cant. Verificada</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="tabla-productos-tbody"></tbody>
                </table>
                <div><p><strong>Progreso:</strong> <span id="progreso-verificacion">- de -</span></p><p><strong>Items Completos:</strong> <span id="items-completos">- de -</span>.</p></div>
                <div class="notas-internas-pedido"><h4>Notas Internas:</h4><textarea id="nota-interna-pedido" placeholder="A√±ade notas..."></textarea><button onclick="guardarNotaInterna()" class="action-button" style="margin-top:10px; background-color:#3498db;">Guardar Nota</button></div>
                <button id="completar-empaque-btn" class="complete-button" style="margin-top:20px;" disabled>Empaque Completo</button>
            </section>
        </div>
        <div id="preguntas-wrapper">
            <h2 class="section-title">Preguntas Pendientes</h2>
            <div style="margin-bottom: 15px;"><label for="filtro-preguntas" style="font-weight:500; margin-right: 10px;">Buscar:</label><input type="text" id="filtro-preguntas" class="scan-input" style="width: calc(100% - 120px); margin-bottom:0; display:inline-block; vertical-align: middle;" placeholder="Filtrar..."></div>
            <div id="lista-preguntas"><p>Cargando preguntas...</p></div>
        </div>
        <div id="mensajes-postventa-wrapper">
            <h2 class="section-title">Mensajes Post-Venta</h2>
            <div id="lista-conversaciones-postventa"><p>Cargando conversaciones...</p></div>
        </div>

        <div id="devoluciones-wrapper">
            <h2 class="section-title">‚Ü©Ô∏è Devoluciones en Proceso</h2>
            <div id="lista-devoluciones-container"><p>Cargando devoluciones...</p></div>
        </div>

        <div id="configuracion-wrapper">
            <h2 class="section-title">‚öôÔ∏è Configuraci√≥n General</h2>
            <div class="config-section">
                <h3>Gesti√≥n de Empaquetadores</h3>
                <div>
                    <label for="nuevo-empaquetador-nombre">Nuevo Empaquetador:</label>
                    <input type="text" id="nuevo-empaquetador-nombre" placeholder="Nombre del empaquetador">
                    <button onclick="agregarEmpaquetador()" class="action-button">Agregar</button>
                </div>
                <div style="margin-top: 15px;">
                    <label for="select-empaquetador-activo">Seleccionar Empaquetador Activo:</label>
                    <select id="select-empaquetador-activo" onchange="seleccionarEmpaquetadorActivo(this.value)">
                        <option value="">-- Ninguno --</option>
                    </select>
                </div>
                <h4>Empaquetadores Actuales:</h4>
                <ul id="lista-empaquetadores-actuales"><p>No hay empaquetadores registrados.</p></ul>
            </div>
             <div class="config-section"> 
                <h3>Sincronizaci√≥n de Cancelaciones (Simulado)</h3>
                <p style="font-size:0.9em; color:#555;">Para simular cancelaciones detectadas desde MercadoLibre, debes modificar el array <code>window.pedidosCanceladosPorMLSimulado</code> directamente en el c√≥digo fuente de esta p√°gina (dentro de la etiqueta <code><script></code>). A√±ade los IDs de los pedidos que deseas simular como cancelados por ML. Luego, presiona el bot√≥n de abajo.</p>
                <button onclick="sincronizarCancelacionesConML()" class="action-button action-button-warning">Sincronizar Cancelaciones con ML (Simulado)</button>
            </div>
        </div>
        <section id="historial-pedidos">
            <h2 class="section-title">Historial de Pedidos</h2>
            <div><label for="fecha-historial">Fecha:</label><input type="date" id="fecha-historial" name="fecha-historial"><button onclick="cargarHistorial()" class="action-button">Ver Historial</button></div>
            <div id="lista-historial-resultados" style="margin-top: 20px;"><p>Seleccione fecha.</p></div>
            <div id="acciones-historial-dia"><button onclick="mostrarResumenProductosDia()" class="action-button">Resumen Productos Vendidos</button></div>
            <div id="resumen-productos-dia-resultados" style="margin-top: 20px;"></div>
        </section>
    </div>

    <div id="modal-mensajes-postventa" class="modal">
        <div class="modal-contenido">
            <div class="modal-header"><h3>Mensajes Pedido: <span id="postventa-pedido-id-modal"></span></h3><span class="modal-cerrar" onclick="cerrarModalMensajesPostventa()">√ó</span></div>
            <div id="chat-postventa-area" class="chat-area"><p>Cargando...</p></div>
            <div class="contenedor-respuesta"><select class="select-plantilla" id="plantillas-postventa" onchange="aplicarPlantilla(this, 'postventa-respuesta-texto')"><option value="">Plantilla...</option></select><textarea id="postventa-respuesta-texto" placeholder="Respuesta..."></textarea><button onclick="enviarRespuestaPostventa()" class="action-button action-button-success">Enviar</button></div>
        </div>
    </div>

    <script>
        // --- Variables Globales y Datos Simulados ---
        let pedidosEmpaquetadosHoyCount = 0;
        window.pedidosDataGlobal = {};
        window.preguntasDataGlobal = [
            { id: "PREG1", itemId: "MLA123", texto: "¬øTienen stock en color azul para el SuperPhone X?", fecha: new Date(Date.now() - 86400000 * 1).toISOString(), unread: true, respondida: false, producto: { nombre: "SuperPhone X - Azul Galaxia", imagen: "https://via.placeholder.com/60/00F/FFF?Text=SPX" } },
            { id: "PREG2", itemId: "MLA456", texto: "¬øHacen env√≠os a Tierra del Fuego para la Tablet GenPad 5?", fecha: new Date(Date.now() - 86400000 * 2).toISOString(), unread: false, respondida: true, respuesta: "S√≠, hacemos env√≠os a todo el pa√≠s a trav√©s de Mercado Env√≠os.", producto: { nombre: "Tablet GenPad 5 - Gris Espacial", imagen: "https://via.placeholder.com/60/888/FFF?Text=GP5" } },
            { id: "PREG3", itemId: "MLA789", texto: "¬øCu√°l es la garant√≠a de los Auriculares SonicBlast? ¬øCubre ca√≠das?", fecha: new Date(Date.now() - 3600000 * 5).toISOString(), unread: true, respondida: false, producto: { nombre: "Auriculares SonicBlast - Negro Mate", imagen: "https://via.placeholder.com/60/222/FFF?Text=SB" } }
        ];
        window.conversacionesDataGlobal = [
            { id: "CONV1", pedidoId: "MELIORDER-FLEX1", clienteNombre: "Juan Flex", ultimoMensaje: "¬°Muchas gracias por la r√°pida respuesta!", fechaUltimoMensaje: new Date(Date.now() - 3600000 * 2).toISOString(), unread: true, mensajes: [ { texto: "¬øPodr√≠an confirmar si mi pedido ya fue preparado?", emisor: "cliente", fecha: new Date(Date.now() - 3600000 * 2.5).toISOString()}, { texto: "Hola Juan! S√≠, tu pedido MELIORDER-FLEX1 ya est√° listo para ser despachado con Flex hoy mismo.", emisor: "vendedor", fecha: new Date(Date.now() - 3600000 * 2.2).toISOString() }, { texto: "¬°Muchas gracias por la r√°pida respuesta!", emisor: "cliente", fecha: new Date(Date.now() - 3600000 * 2).toISOString()} ] },
            { id: "CONV2", pedidoId: "MELIORDER-CORREO1", clienteNombre: "Maria Correo", ultimoMensaje: "Ok, aguardo el c√≥digo de seguimiento. Saludos.", fechaUltimoMensaje: new Date(Date.now() - 86400000 * 1.5).toISOString(), unread: false, mensajes: [ { texto: "Buenas tardes, realic√© una compra ayer, ¬øcu√°ndo lo despachan?", emisor: "cliente", fecha: new Date(Date.now() - 86400000 * 1.7).toISOString() }, { texto: "Hola Maria, tu pedido MELIORDER-CORREO1 se despacha hoy por la tarde. Te llegar√° el c√≥digo de seguimiento autom√°ticamente. Saludos!", emisor: "vendedor", fecha: new Date(Date.now() - 86400000 * 1.6).toISOString() }, { texto: "Ok, aguardo el c√≥digo de seguimiento. Saludos.", emisor: "cliente", fecha: new Date(Date.now() - 86400000 * 1.5).toISOString() } ] }
        ];
        window.historialPedidosGlobal = {};
        window.devolucionesDataGlobal = [];
        window.empaquetadoresDisponibles = [];
        window.empaquetadorActivo = null;

        // Modifica este array con los IDs que quieres simular como cancelados por ML
        // antes de presionar el bot√≥n de sincronizaci√≥n en Configuraci√≥n.
        window.pedidosCanceladosPorMLSimulado = ['MELIORDER-FLEX1', 'ID-PEDIDO-QUE-NO-EXISTE']; // Ejemplo

        const plantillasRespuesta = [
            { id: "saludo_stock", titulo: "Saludo + Hay Stock", texto: "¬°Hola! Gracias por tu consulta. S√≠, tenemos stock disponible para entrega inmediata. ¬°Esperamos tu compra! Saludos." },
            { id: "despedida_stock", titulo: "Consulta Stock + Despedida", texto: "¬°Hola! S√≠, tenemos stock. Cualquier otra duda, av√≠sanos. ¬°Saludos!"},
            { id: "agradecimiento_compra", titulo: "Agradecimiento Post-Venta", texto: "¬°Hola! Muchas gracias por tu compra. Estamos preparando tu pedido y te avisaremos cuando sea despachado. Saludos." },
            { id: "info_envio", titulo: "Info Env√≠o Est√°ndar", texto: "¬°Hola! Tu pedido ser√° despachado en las pr√≥ximas 24hs h√°biles. Recibir√°s el c√≥digo de seguimiento por este medio y por email. Saludos."},
            { id: "respuesta_generica", titulo: "Respuesta Gen√©rica", texto: "¬°Hola! Gracias por comunicarte. Estamos revisando tu consulta y te responderemos a la brevedad. Saludos."}
        ];
        const MOTIVOS_DEVOLUCION = ["No me gust√≥/No era lo que esperaba", "Talle/Color incorrecto", "Producto defectuoso", "Me arrepent√≠ de la compra", "Da√±ado en el env√≠o"];
        const ESTADOS_DEVOLUCION = [
            "Iniciada", "En tr√°nsito al vendedor", "Recibida por el vendedor", "Inspecci√≥n completada",
            "Procesada (Stock Reingresado)", "Procesada (Items Descartados)", 
            "Reembolso procesado", "Cerrada", "Cancelada"
        ];
        const pedidosSimuladosBase = [ 
            {id: 'MELIORDER-TURBO1', cliente: 'Cliente Turbo', itemsCount: 2, tipoEnvio: 'TURBO', esCancelado: false, fechaCancelacion: null, productos: [{img: "https://via.placeholder.com/50/FF00FF/000000?Text=PT1", nombre: "Prod Turbo A", sku: "TUR-A", pedida: 1}, {img: "https://via.placeholder.com/50/FFFF00/000000?Text=PT2", nombre: "Prod Turbo B", sku: "TUR-B", pedida: 1}]},
            {id: 'MELIORDER-FLEX1', cliente: 'Juan Flex', itemsCount: 3, tipoEnvio: 'FLEX', esCancelado: false, fechaCancelacion: null, productos: [{img: "https://via.placeholder.com/50/FF0000/FFFFFF?Text=P1", nombre: "Botella Azul", sku: "BT500-AZUL", pedida: 2, ubicacion: "A1-S3", notaProducto: "Revisar tapa"}, {img: "https://via.placeholder.com/50/00FF00/FFFFFF?Text=P2", nombre: "Taza Gato", sku: "TAZA-CL01", pedida: 1, ubicacion: "B2-S1"}]},
            {id: 'MELIORDER-CORREO1', cliente: 'Maria Correo', itemsCount: 1, tipoEnvio: 'CORREO', esCancelado: false, fechaCancelacion: null, notaInterna: "Revisar direcci√≥n de env√≠o antes de imprimir etiqueta.", productos: [{img: "https://via.placeholder.com/50/0000FF/FFFFFF?Text=P3", nombre: "Libreta Ecol√≥gica", sku: "LIB-ECO-R", pedida: 1, ubicacion: "D1-S2", notaProducto: "Color verde oscuro"}]},
            {id: 'MELIORDER-RETIRO1', cliente: 'Laura Retira', itemsCount: 1, tipoEnvio: 'RETIRO', esCancelado: false, fechaCancelacion: null, notaInterna: "Llama media hora antes. Paga saldo pendiente.", productos: [{img: "https://via.placeholder.com/50/800080/FFFFFF?Text=PR1", nombre: "Producto para Retiro Especial", sku: "PROD-RET-ESP", pedida: 1, ubicacion: "Mostrador Caja", notaProducto: "Preparar en bolsa especial regalo."}]}
        ];

        // --- DEFINICIONES DE FUNCIONES ---

        function mostrarSeccion(idSeccion) {
            const secciones = ['dashboard-wrapper', 'verificacion-actual-wrapper', 'historial-pedidos', 'preguntas-wrapper', 'mensajes-postventa-wrapper', 'configuracion-wrapper', 'devoluciones-wrapper'];
            secciones.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; else console.warn("mostrarSeccion: No se encontr√≥ el div de secci√≥n:", id);});
           
            const seccionActiva = document.getElementById(idSeccion);
            if (seccionActiva) seccionActiva.style.display = 'block';
            else { console.error(`mostrarSeccion: Elemento ${idSeccion} no encontrado.`); return; }
           
            if (idSeccion === 'dashboard-wrapper') { actualizarDashboard(); actualizarInfoEmpaquetadorActivoDashboard(); checkForRecentCancellations(); } 
            else if (idSeccion === 'preguntas-wrapper') { cargarPreguntasSinResponder(); popularSelectsPlantillas(); }
            else if (idSeccion === 'mensajes-postventa-wrapper') { cargarConversacionesPostventa(); popularSelectsPlantillas(); }
            else if (idSeccion === 'verificacion-actual-wrapper') { document.getElementById('verificacion-pedido').style.display = document.getElementById('id-pedido-actual').textContent ? 'block' : 'none'; }
            else if (idSeccion === 'configuracion-wrapper') { popularListaEmpaquetadoresUI(); }
            else if (idSeccion === 'devoluciones-wrapper') { cargarVistaDevoluciones(); }
        }

        function actualizarDashboard() {
            function setMetric(id, value) { const el = document.getElementById(id); if (el) el.textContent = value; else console.warn("setMetric: No se encontr√≥ el elemento:", id); }
            const hoyStr = new Date().toISOString().split('T')[0];
            
            const empaquetadosHoyNoCancelados = (window.historialPedidosGlobal[hoyStr] || [])
                .filter(p => p.empaquetado && p.fechaCompletado === hoyStr && (!p.esCancelado || p.fechaCancelacion?.split('T')[0] !== hoyStr))
                .length;
            setMetric('db-pedidos-empaquetados', empaquetadosHoyNoCancelados);

            const canceladosPostEmpaqueHoy = (window.historialPedidosGlobal[hoyStr] || [])
                .filter(p => p.empaquetado && p.fechaCompletado === hoyStr && p.esCancelado && p.fechaCancelacion?.split('T')[0] === hoyStr)
                .length;
            setMetric('db-cancelados-post-empaque-hoy', canceladosPostEmpaqueHoy);

            setMetric('db-preguntas-pendientes', window.preguntasDataGlobal.filter(p => p.unread && !p.respondida).length);
            setMetric('db-mensajes-nuevos', window.conversacionesDataGlobal.filter(c => c.unread).length);
            setMetric('db-devoluciones-activas', window.devolucionesDataGlobal.filter(d => !['Procesada (Stock Reingresado)', 'Procesada (Items Descartados)', 'Reembolso procesado', 'Cerrada', 'Cancelada'].includes(d.estadoDevolucion)).length);
           
            let totalPendientesEmpaque = 0;
            const pedidosPendientesNoCancelados = Object.values(window.pedidosDataGlobal).filter(p => !p.empaquetado && !p.esCancelado);

            setMetric('db-turbo-pendientes', pedidosPendientesNoCancelados.filter(p => p.tipoEnvio === 'TURBO').length);
            setMetric('db-flex-pendientes', pedidosPendientesNoCancelados.filter(p => p.tipoEnvio === 'FLEX').length);
            setMetric('db-correo-pendientes', pedidosPendientesNoCancelados.filter(p => p.tipoEnvio === 'CORREO').length);
            setMetric('db-retiros-pendientes', pedidosPendientesNoCancelados.filter(p => p.tipoEnvio === 'RETIRO').length);
            totalPendientesEmpaque = pedidosPendientesNoCancelados.length;
            
            setMetric('db-total-pendientes', totalPendientesEmpaque);
        }
 
        function checkForRecentCancellations() {
            const avisoDiv = document.getElementById('aviso-cancelados-recientes');
            if (!avisoDiv) return;

            const hoyStr = new Date().toISOString().split('T')[0];
            let hayCanceladosRecientesQueFueronEmpaquetados = false;

            for (const fecha in window.historialPedidosGlobal) {
                for (const pedido of window.historialPedidosGlobal[fecha]) {
                    if (pedido.empaquetado && pedido.esCancelado) {
                         const fechaCancelacion = pedido.fechaCancelacion?.split('T')[0];
                         const ayerStr = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                         if (fechaCancelacion === hoyStr || fechaCancelacion === ayerStr) {
                            hayCanceladosRecientesQueFueronEmpaquetados = true;
                            break;
                         }
                    }
                }
                if (hayCanceladosRecientesQueFueronEmpaquetados) break;
            }

            if (hayCanceladosRecientesQueFueronEmpaquetados) {
                avisoDiv.innerHTML = `<strong>Atenci√≥n:</strong> Se han detectado pedidos que fueron empaquetados y posteriormente cancelados recientemente. Por favor, revisa el Historial de Pedidos para m√°s detalles y tomar acciones si es necesario (ej. recuperar productos del √°rea de empaque).`;
                avisoDiv.style.display = 'block';
            } else {
                avisoDiv.style.display = 'none';
            }
        }
       
        function actualizarBadgeNotificaciones(badgeId) { 
            const badge = document.getElementById(badgeId);
            if (!badge) return;
            let count = 0;
            if (badgeId === 'notif-badge-preguntas') count = window.preguntasDataGlobal.filter(p => p.unread && !p.respondida).length;
            else if (badgeId === 'notif-badge-postventa') count = window.conversacionesDataGlobal.filter(c => c.unread).length;
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
            if (badgeId === 'notif-badge-preguntas' && document.getElementById('dashboard-wrapper').style.display === 'block') {
                const el = document.getElementById('db-preguntas-pendientes');
                if(el) el.textContent = count;
            }
            if (badgeId === 'notif-badge-postventa' && document.getElementById('dashboard-wrapper').style.display === 'block') {
                 const el = document.getElementById('db-mensajes-nuevos');
                 if(el) el.textContent = count;
            }
        }

        function agregarEmpaquetador() {
            const inputNombre = document.getElementById('nuevo-empaquetador-nombre');
            const nombre = inputNombre.value.trim();
            if (!nombre) { alert("Nombre vac√≠o."); return; }
            if (window.empaquetadoresDisponibles.map(n=>n.toLowerCase()).includes(nombre.toLowerCase())) { alert("Empaquetador ya existe."); return; }
            window.empaquetadoresDisponibles.push(nombre);
            window.empaquetadoresDisponibles.sort((a, b) => a.localeCompare(b));
            inputNombre.value = "";
            popularListaEmpaquetadoresUI();
            guardarConfiguracionEmpaquetadores();
        }
       
        function eliminarEmpaquetador(nombreAEliminar) {
            if (!confirm(`¬øEliminar "${nombreAEliminar}"?`)) return;
            window.empaquetadoresDisponibles = window.empaquetadoresDisponibles.filter(n => n !== nombreAEliminar);
            if (window.empaquetadorActivo === nombreAEliminar) window.empaquetadorActivo = null;
            popularListaEmpaquetadoresUI();
            guardarConfiguracionEmpaquetadores();
            actualizarInfoEmpaquetadorActivoDashboard();
            actualizarProgresoGeneral();
        }

        function popularListaEmpaquetadoresUI() {
            const select = document.getElementById('select-empaquetador-activo');
            const listaUL = document.getElementById('lista-empaquetadores-actuales');
            if(!select || !listaUL) { console.error("Elementos para UI de empaquetadores no encontrados"); return; }
            select.innerHTML = '<option value="">-- Ninguno --</option>';
            listaUL.innerHTML = '';
            if (window.empaquetadoresDisponibles.length === 0) {
                 listaUL.innerHTML = '<p>No hay empaquetadores.</p>';
            } else {
                window.empaquetadoresDisponibles.forEach(nombre => {
                    select.innerHTML += `<option value="${nombre}">${nombre}</option>`;
                    const li = document.createElement('li');
                    li.textContent = nombre;
                    const btnEliminar = document.createElement('button');
                    btnEliminar.textContent = 'Eliminar';
                    btnEliminar.className = 'action-button action-button-danger';
                    btnEliminar.onclick = () => eliminarEmpaquetador(nombre);
                    li.appendChild(btnEliminar);
                    listaUL.appendChild(li);
                });
            }
            select.value = window.empaquetadorActivo || "";
            actualizarInfoEmpaquetadorActivoDashboard();
        }

        function seleccionarEmpaquetadorActivo(nombre) {
            window.empaquetadorActivo = nombre || null;
            actualizarInfoEmpaquetadorActivoDashboard();
            guardarConfiguracionEmpaquetadores();
            actualizarProgresoGeneral();
        }
       
        function actualizarInfoEmpaquetadorActivoDashboard() {
            const infoDiv = document.getElementById('empaquetador-activo-info');
            if (infoDiv) {
                infoDiv.textContent = window.empaquetadorActivo ? `Empaquetador Activo: ${window.empaquetadorActivo}` : 'Empaquetador: Ninguno (ir a Config.)';
                infoDiv.classList.toggle('no-seleccionado', !window.empaquetadorActivo);
            }
        }

        function guardarConfiguracionEmpaquetadores() {
            localStorage.setItem('empaquetadoresDisponibles', JSON.stringify(window.empaquetadoresDisponibles));
            localStorage.setItem('empaquetadorActivo', window.empaquetadorActivo || "");
        }

        function cargarConfiguracionEmpaquetadores() {
            window.empaquetadoresDisponibles = JSON.parse(localStorage.getItem('empaquetadoresDisponibles') || '["Ana", "Luis", "Carlos"]');
            window.empaquetadorActivo = localStorage.getItem('empaquetadorActivo') || null;
            if(window.empaquetadorActivo && !window.empaquetadoresDisponibles.includes(window.empaquetadorActivo)) window.empaquetadorActivo = null;
        }

         function popularListasDePedidosPendientes() {
            if (Object.keys(window.pedidosDataGlobal).length === 0) {
                 const guardados = localStorage.getItem('pedidosDataGlobal');
                 if (guardados) {
                    window.pedidosDataGlobal = JSON.parse(guardados);
                 } else { 
                    pedidosSimuladosBase.forEach(p => { 
                        p.productos.forEach(prod => prod.verificada = 0);
                        window.pedidosDataGlobal[p.id] = JSON.parse(JSON.stringify({ 
                            ...p, 
                            empaquetado: false, 
                            fechaCompletado: null, 
                            empaquetadoPor: null, 
                            stockDescontadoConfirmado: false,
                            esCancelado: p.esCancelado || false, 
                            fechaCancelacion: p.fechaCancelacion || null
                        })); 
                    });
                    guardarPedidosDataGlobal();
                 }
            }
            const listDivs = { TURBO: document.getElementById('pedidos-turbo-list'), FLEX: document.getElementById('pedidos-flex-list'), CORREO: document.getElementById('pedidos-correo-list'), RETIRO: document.getElementById('pedidos-retiro-list') };
            Object.values(listDivs).forEach(div => { if(div) div.innerHTML = ''; else console.warn("popularListasDePedidosPendientes: Falta un DIV de lista de pedidos"); }); 
            
            let counts = { TURBO: 0, FLEX: 0, CORREO: 0, RETIRO: 0 };
            Object.values(window.pedidosDataGlobal).filter(p => !p.empaquetado && !p.esCancelado).forEach(pedido => {
                const pedidoHtml = `<div class="order-list-item" onclick="cargarPedido('${pedido.id}')" data-order-id="${pedido.id}">#${pedido.id} - ${pedido.cliente} (${pedido.itemsCount})</div>`;
                const tipoKey = pedido.tipoEnvio?.toUpperCase() || 'CORREO';
                if (listDivs[tipoKey]) { listDivs[tipoKey].innerHTML += pedidoHtml; counts[tipoKey]++; }
                else if (listDivs.CORREO) { listDivs.CORREO.innerHTML += pedidoHtml; counts.CORREO++;}
            });
            Object.keys(listDivs).forEach(key => { if (counts[key] === 0 && listDivs[key]) listDivs[key].innerHTML = `<p>No hay pedidos ${key.toLowerCase()} pendientes.</p>`; });
            actualizarDashboard(); 
        }

         function cargarPedido(idPedido) {
            const idPedidoActualSpan = document.getElementById('id-pedido-actual');
            if (idPedidoActualSpan) idPedidoActualSpan.textContent = idPedido;
            const datosPedido = window.pedidosDataGlobal[idPedido];
            const tablaBody = document.getElementById('tabla-productos-tbody');
            const notaTextarea = document.getElementById('nota-interna-pedido');
            if (!datosPedido || !tablaBody || !notaTextarea) {
                console.error("Error al cargar pedido: elementos no encontrados o datos de pedido faltantes.");
                if(tablaBody) tablaBody.innerHTML = '<tr><td colspan="7" style="color:red;">Error al cargar datos del pedido.</td></tr>';
                return;
            }
            if (datosPedido.esCancelado) { 
                 alert(`El pedido ${idPedido} est√° cancelado y no puede ser procesado para verificaci√≥n.`);
                 document.getElementById('id-pedido-actual').textContent = '';
                 document.getElementById('verificacion-pedido').style.display = 'none';
                 return;
            }

            tablaBody.innerHTML = '';
            (datosPedido.productos || []).forEach((p, index) => {
                const row = tablaBody.insertRow();
                p.id_instancia_pedido = p.id_instancia_pedido || p.sku || `${idPedido}-item-${index}`; 
                row.dataset.itemId = p.id_instancia_pedido;
                row.insertCell().innerHTML = `<img src="${p.img || 'https://via.placeholder.com/50'}" alt="Prod">`;
                row.insertCell().textContent = p.nombre;
                row.insertCell().textContent = p.sku;
                row.insertCell().innerHTML = `${p.ubicacion ? `<div class="detalle-producto-adicional"><strong>Ubicaci√≥n:</strong> ${p.ubicacion}</div>` : ''}${p.notaProducto ? `<div class="detalle-producto-adicional"><strong>Nota Prod.:</strong> ${p.notaProducto}</div>` : (!p.ubicacion && !p.notaProducto ? '-' : '')}`;
                row.insertCell().textContent = p.pedida;
                row.insertCell().className = 'cant-verificada';
                row.cells[5].textContent = p.verificada || 0;
                const btn = document.createElement('button');
                btn.className = 'action-button';
                if ((p.verificada || 0) >= p.pedida) { btn.textContent = '‚úì'; btn.disabled = true; btn.style.backgroundColor = '#27ae60';}
                else { btn.textContent = 'Verificar'; btn.onclick = () => verificarItemConClick(btn, p.id_instancia_pedido); }
                row.insertCell().appendChild(btn);
            });
            notaTextarea.value = datosPedido.notaInterna || "";
            actualizarProgresoGeneral();
            document.getElementById('verificacion-pedido').style.display = 'block';
            const barcodeScanner = document.getElementById('barcode-scanner');
            if (barcodeScanner) { barcodeScanner.value = ''; barcodeScanner.focus(); }
        }

         function verificarItemConClick(boton, itemIdInstanciaPedido) {
            const idPedidoActual = document.getElementById('id-pedido-actual').textContent;
            if (!idPedidoActual || !window.pedidosDataGlobal[idPedidoActual]) return;
            const producto = window.pedidosDataGlobal[idPedidoActual].productos.find(p => p.id_instancia_pedido === itemIdInstanciaPedido);
            if (producto) {
                producto.verificada = (producto.verificada || 0) + 1;
                const fila = boton.closest('tr');
                if(fila) {
                    const celdaVerif = fila.querySelector('.cant-verificada');
                    if (celdaVerif) celdaVerif.textContent = producto.verificada;
                }
                if (producto.verificada >= producto.pedida) {
                    boton.textContent = '‚úì'; boton.disabled = true; boton.style.backgroundColor = '#27ae60';
                }
            }
            actualizarProgresoGeneral();
        }

        function actualizarProgresoGeneral() {
            const idPedidoActual = document.getElementById('id-pedido-actual').textContent;
            const spanProgreso = document.getElementById('progreso-verificacion');
            const spanItemsCompletos = document.getElementById('items-completos');
            const btnCompletarEmpaque = document.getElementById('completar-empaque-btn');

            if (!spanProgreso || !spanItemsCompletos || !btnCompletarEmpaque) {
                console.error("Elementos de UI de progreso no encontrados.");
                return;
            }

            if (!idPedidoActual || !window.pedidosDataGlobal[idPedidoActual] || document.getElementById('verificacion-pedido').style.display === 'none') {
                spanProgreso.textContent = '- de -'; spanItemsCompletos.textContent = '- de -'; btnCompletarEmpaque.disabled = true;
                return;
            }
            const pedido = window.pedidosDataGlobal[idPedidoActual];
            if (!pedido.productos || pedido.productos.length === 0) {
                 spanProgreso.textContent = '0 de 0'; spanItemsCompletos.textContent = '0 de 0'; btnCompletarEmpaque.disabled = true;
                 return;
            }
            let totalPedida = 0, totalVerif = 0, skusDistintos = pedido.productos.length, skusCompletos = 0;
            pedido.productos.forEach(p => { totalPedida += p.pedida; totalVerif += (p.verificada || 0); if ((p.verificada || 0) >= p.pedida) skusCompletos++; });
            spanProgreso.textContent = `${totalVerif} de ${totalPedida}`;
            spanItemsCompletos.textContent = `${skusCompletos} de ${skusDistintos}`;
            if (!window.empaquetadorActivo) { btnCompletarEmpaque.disabled = true; btnCompletarEmpaque.title = "Seleccione empaquetador."; }
            else { btnCompletarEmpaque.disabled = totalVerif < totalPedida; btnCompletarEmpaque.title = totalVerif < totalPedida ? "Verifique √≠tems" : "Completar"; }
        }

        function guardarNotaInterna() {
            const idPedidoActual = document.getElementById('id-pedido-actual').textContent;
            const notaTextarea = document.getElementById('nota-interna-pedido');
            if (!idPedidoActual || !window.pedidosDataGlobal[idPedidoActual] || !notaTextarea) { alert("Error."); return;}
            window.pedidosDataGlobal[idPedidoActual].notaInterna = notaTextarea.value;
            guardarPedidosDataGlobal();
            alert("Nota guardada.");
        }

        function guardarPedidosDataGlobal() { localStorage.setItem('pedidosDataGlobal', JSON.stringify(window.pedidosDataGlobal)); }
        function guardarHistorialPedidosGlobal() { localStorage.setItem('historialPedidosGlobal', JSON.stringify(window.historialPedidosGlobal));}

        function finalizarPedidoActual() {
            const idPedidoActual = document.getElementById('id-pedido-actual').textContent;
             if (!window.empaquetadorActivo) { alert("Seleccione empaquetador en Configuraci√≥n."); return; }
            if (!idPedidoActual || !window.pedidosDataGlobal[idPedidoActual]) { alert("No hay pedido activo."); return; }

            const pedido = window.pedidosDataGlobal[idPedidoActual];
            if (pedido.esCancelado) { 
                alert(`El pedido ${idPedidoActual} est√° cancelado y no puede ser completado.`);
                return;
            }

            pedido.empaquetado = true;
            pedido.empaquetadoPor = window.empaquetadorActivo;
            pedido.fechaCompletado = new Date().toISOString().split('T')[0];
            pedido.stockDescontadoConfirmado = false; 

            const itemListaPedido = document.querySelector(`.order-list-item[data-order-id="${idPedidoActual}"]`);
            if (itemListaPedido) {
                const parentList = itemListaPedido.parentElement;
                itemListaPedido.remove();
                if(parentList) actualizarMensajeListaVacia(parentList.id);
            }
           
            const hoy = pedido.fechaCompletado;
            if (!window.historialPedidosGlobal[hoy]) window.historialPedidosGlobal[hoy] = [];
            if (!window.historialPedidosGlobal[hoy].find(p => p.id === pedido.id)) {
                 window.historialPedidosGlobal[hoy].push(JSON.parse(JSON.stringify(pedido))); 
            }
            
            // Opcional: Considerar si se debe eliminar el pedido de pedidosDataGlobal.
            // Si se elimina, la l√≥gica de `sincronizarCancelacionesConML` solo lo encontrar√° en el historial.
            // Si se mantiene, `sincronizarCancelacionesConML` lo podr√≠a encontrar en ambos y marcarlo en `pedidosDataGlobal`
            // aunque ya no sea visible en las listas de pendientes. Por ahora, no se elimina para mantener consistencia.
            // Si se decide eliminarlo: delete window.pedidosDataGlobal[idPedidoActual];

            guardarPedidosDataGlobal();
            guardarHistorialPedidosGlobal();

            document.getElementById('id-pedido-actual').textContent = '';
            document.getElementById('tabla-productos-tbody').innerHTML = '';
            document.getElementById('nota-interna-pedido').value = '';
            document.getElementById('barcode-scanner').value = '';
            document.getElementById('verificacion-pedido').style.display = 'none'; 
           
            actualizarProgresoGeneral();
            actualizarDashboard();
            alert(`Pedido ${idPedidoActual} completado por ${pedido.empaquetadoPor}.`);
        }
       
        function actualizarMensajeListaVacia(listId) {
            const listaDiv = document.getElementById(listId);
            if (listaDiv) {
                const itemsCount = listaDiv.querySelectorAll('.order-list-item').length;
                if (itemsCount === 0) {
                    const tipoLista = listId.replace('pedidos-', '').replace('-list', '');
                    listaDiv.innerHTML = `<p>No hay pedidos ${tipoLista} pendientes.</p>`;
                }
            }
        }

        function popularSelectsPlantillas() {
            const selects = document.querySelectorAll('.select-plantilla');
            selects.forEach(select => {
                const defaultOption = select.querySelector('option[value=""]');
                select.innerHTML = '';
                if (defaultOption) select.appendChild(defaultOption.cloneNode(true));

                plantillasRespuesta.forEach(plantilla => {
                    const option = document.createElement('option');
                    option.value = plantilla.id;
                    option.textContent = plantilla.titulo;
                    select.appendChild(option);
                });
            });
        }

        function aplicarPlantilla(selectElement, textareaId) {
            const plantillaId = selectElement.value;
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            const plantillaSeleccionada = plantillasRespuesta.find(p => p.id === plantillaId);
            if (plantillaSeleccionada) {
                textarea.value = plantillaSeleccionada.texto;
                textarea.focus();
            } else if (plantillaId === "") { 
                textarea.value = ""; 
            }
        }
        
        function cargarPreguntasSinResponder() {
            const divListaPreguntas = document.getElementById('lista-preguntas');
            if (!divListaPreguntas) return;

            divListaPreguntas.innerHTML = ''; 
            const filtroTexto = document.getElementById('filtro-preguntas')?.value.toLowerCase() || '';

            const preguntasFiltradas = window.preguntasDataGlobal.filter(pregunta => {
                const textoBusqueda = `${pregunta.texto} ${pregunta.producto.nombre} ${pregunta.itemId}`.toLowerCase();
                return textoBusqueda.includes(filtroTexto);
            });

            if (preguntasFiltradas.length === 0) {
                divListaPreguntas.innerHTML = "<p>No hay preguntas que coincidan con el filtro o no hay preguntas pendientes.</p>";
            } else {
                preguntasFiltradas.forEach(pregunta => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `pregunta-item ${pregunta.unread && !pregunta.respondida ? 'item-no-leido' : 'item-leido'}`;
                    itemDiv.id = `preg-${pregunta.id}`;
                    itemDiv.innerHTML = `
                        <img src="${pregunta.producto.imagen}" alt="Producto ${pregunta.producto.nombre}">
                        <div class="pregunta-info">
                            <p><strong>Producto:</strong> ${pregunta.producto.nombre} (Art√≠culo: ${pregunta.itemId})</p>
                            <p class="pregunta-texto"><strong>Pregunta:</strong> ${pregunta.texto}</p>
                            <p class="pregunta-meta">Recibida: ${new Date(pregunta.fecha).toLocaleString('es-AR')} ${pregunta.respondida ? `- Respondida` : `- Pendiente`}</p>
                            ${!pregunta.respondida ? `
                            <div class="contenedor-respuesta">
                                <select class="select-plantilla" id="plantilla-preg-${pregunta.id}" onchange="aplicarPlantilla(this, 'respuesta-preg-${pregunta.id}')">
                                    <option value="">Plantilla...</option>
                                </select>
                                <textarea id="respuesta-preg-${pregunta.id}" placeholder="Escribe tu respuesta aqu√≠...">${pregunta.respuesta || ''}</textarea>
                            </div>
                            <div class="item-acciones">
                                <button class="action-button action-button-success" onclick="responderPregunta('${pregunta.id}')">Responder</button>
                                <button class="action-button ${pregunta.unread ? 'action-button-secondary' : ''}" onclick="toggleLeidoPregunta('${pregunta.id}', this)">
                                    Marcar como ${pregunta.unread ? 'Le√≠da' : 'No Le√≠da'}
                                </button>
                            </div>` : `<p><strong>Respuesta:</strong> ${pregunta.respuesta}</p>`}
                        </div>`;
                    divListaPreguntas.appendChild(itemDiv);
                });
            }
            actualizarBadgeNotificaciones('notif-badge-preguntas');
            popularSelectsPlantillas(); 
        }
        
        function toggleLeidoPregunta(idPregunta, boton) {
            const pregunta = window.preguntasDataGlobal.find(p => p.id === idPregunta);
            if (pregunta && !pregunta.respondida) {
                pregunta.unread = !pregunta.unread;
                console.log(`Pregunta ${idPregunta} marcada como ${pregunta.unread ? 'no le√≠da' : 'le√≠da'}`);
                cargarPreguntasSinResponder(); 
                actualizarDashboard();
            }
        }

        function responderPregunta(idPregunta) {
            const pregunta = window.preguntasDataGlobal.find(p => p.id === idPregunta);
            const textareaRespuesta = document.getElementById(`respuesta-preg-${pregunta.id}`);
            if (pregunta && textareaRespuesta && !pregunta.respondida) {
                const respuestaTexto = textareaRespuesta.value.trim();
                if (!respuestaTexto) {
                    alert("La respuesta no puede estar vac√≠a.");
                    return;
                }
                if (!confirm(`Confirmar respuesta para pregunta ${idPregunta}:\n"${respuestaTexto}"`)) return;

                pregunta.respuesta = respuestaTexto;
                pregunta.respondida = true;
                pregunta.unread = false; 
                console.log(`Respuesta enviada para ${idPregunta}: ${pregunta.respuesta}`);
                alert(`Respuesta para pregunta ${idPregunta} guardada (simulado).`);
                cargarPreguntasSinResponder(); 
                actualizarDashboard();
            }
        }

        function filtrarListaPreguntas() {
            cargarPreguntasSinResponder(); 
        }

        function cargarConversacionesPostventa() {
            const divConversaciones = document.getElementById('lista-conversaciones-postventa');
            if (!divConversaciones) return;
            divConversaciones.innerHTML = '';

            if (window.conversacionesDataGlobal.length === 0) {
                divConversaciones.innerHTML = "<p>No hay conversaciones de post-venta.</p>";
            } else {
                const conversacionesOrdenadas = [...window.conversacionesDataGlobal].sort((a, b) => {
                    if (a.unread !== b.unread) return a.unread ? -1 : 1;
                    return new Date(b.fechaUltimoMensaje) - new Date(a.fechaUltimoMensaje);
                });

                conversacionesOrdenadas.forEach(conv => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `conversacion-item ${conv.unread ? 'item-no-leido' : 'item-leido'}`;
                    itemDiv.id = `conv-${conv.id}`;
                    itemDiv.innerHTML = `
                        <p><strong>Pedido:</strong> ${conv.pedidoId} - <strong>Cliente:</strong> ${conv.clienteNombre}</p>
                        <p><em>√öltimo mensaje:</em> "${conv.ultimoMensaje}"</p>
                        <p class="conversacion-meta">Fecha √∫ltimo mensaje: ${new Date(conv.fechaUltimoMensaje).toLocaleString('es-AR')}</p>
                        <div class="item-acciones">
                            <button class="action-button" onclick="abrirModalMensajesPostventa('${conv.id}')">Ver/Responder</button>
                            <button class="action-button ${conv.unread ? 'action-button-secondary' : ''}" onclick="toggleLeidoConversacion('${conv.id}', ${!conv.unread})">
                                Marcar como ${conv.unread ? 'Le√≠da' : 'No Le√≠da'}
                            </button>
                        </div>
                    `;
                    divConversaciones.appendChild(itemDiv);
                });
            }
            actualizarBadgeNotificaciones('notif-badge-postventa');
        }
        
        function toggleLeidoConversacion(idConversacion, marcarComoLeido) {
            const conv = window.conversacionesDataGlobal.find(c => c.id === idConversacion);
            if (conv) {
                conv.unread = !marcarComoLeido;
                console.log(`Conversaci√≥n ${idConversacion} marcada como ${conv.unread ? 'no le√≠da' : 'le√≠da'}`);
                cargarConversacionesPostventa(); 
                actualizarDashboard();
            }
        }
        
        let conversacionActivaIdModal = null;
        function abrirModalMensajesPostventa(idConversacion) {
            conversacionActivaIdModal = idConversacion;
            const conv = window.conversacionesDataGlobal.find(c => c.id === idConversacion);
            if (!conv) return;

            document.getElementById('postventa-pedido-id-modal').textContent = conv.pedidoId;
            renderizarMensajesPostventa(idConversacion, conv.mensajes);
            
            const modal = document.getElementById('modal-mensajes-postventa');
            modal.style.display = 'block';
            document.getElementById('postventa-respuesta-texto').value = '';
            document.getElementById('plantillas-postventa').value = ''; 
            
            if (conv.unread) { 
                toggleLeidoConversacion(idConversacion, true);
            }
        }
        
        function renderizarMensajesPostventa(idConv, mensajes) {
            const chatArea = document.getElementById('chat-postventa-area');
            chatArea.innerHTML = '';
            if (!mensajes || mensajes.length === 0) {
                chatArea.innerHTML = '<p style="text-align:center; color:#7f8c8d;">No hay mensajes en esta conversaci√≥n a√∫n.</p>';
                return;
            }
            mensajes.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `mensaje ${msg.emisor === 'cliente' ? 'mensaje-recibido' : 'mensaje-enviado'}`;
                msgDiv.innerHTML = `<p>${msg.texto}</p><span class="mensaje-meta">${new Date(msg.fecha).toLocaleString('es-AR')}</span>`;
                chatArea.appendChild(msgDiv);
            });
            chatArea.scrollTop = chatArea.scrollHeight; 
        }
        
        function cerrarModalMensajesPostventa() {
            const modal = document.getElementById('modal-mensajes-postventa');
            modal.style.display = 'none';
            conversacionActivaIdModal = null;
        }

        function enviarRespuestaPostventa() {
            if (!conversacionActivaIdModal) return;
            const conv = window.conversacionesDataGlobal.find(c => c.id === conversacionActivaIdModal);
            const textarea = document.getElementById('postventa-respuesta-texto');
            if (!conv || !textarea) return;

            const textoRespuesta = textarea.value.trim();
            if (!textoRespuesta) {
                alert("La respuesta no puede estar vac√≠a.");
                return;
            }

            const nuevoMensaje = {
                texto: textoRespuesta,
                emisor: "vendedor",
                fecha: new Date().toISOString()
            };
            conv.mensajes.push(nuevoMensaje);
            conv.ultimoMensaje = textoRespuesta;
            conv.fechaUltimoMensaje = nuevoMensaje.fecha;
            conv.unread = false; 

            console.log(`Respuesta enviada en conv ${conv.id}: ${textoRespuesta}`);
            alert("Respuesta enviada (simulado).");

            renderizarMensajesPostventa(conv.id, conv.mensajes);
            textarea.value = '';
            document.getElementById('plantillas-postventa').value = '';
            cargarConversacionesPostventa(); 
            actualizarDashboard();
        }
        
        function inicializarDatosDevoluciones() {
            const guardadas = localStorage.getItem('devolucionesDataGlobal');
            if (guardadas) window.devolucionesDataGlobal = JSON.parse(guardadas);
            else { 
                window.devolucionesDataGlobal = [
                    {
                        devolucionId: "DEVML001", orderIdOriginal: "MELIORDER-FLEX1", clienteNombre: "Juan Flex",
                        fechaInicioDevolucion: new Date(Date.now() - 86400000 * 3).toISOString(), motivoDevolucion: "No me gust√≥/No era lo que esperaba",
                        estadoDevolucion: "Recibida por el vendedor",
                        productosDevueltos: [{ sku: "BT500-AZUL", nombre: "Botella Azul", cantidad: 1 }]
                    },
                    {
                        devolucionId: "DEVML002", orderIdOriginal: "MELIORDER-CORREO1", clienteNombre: "Maria Correo",
                        fechaInicioDevolucion: new Date(Date.now() - 86400000 * 5).toISOString(), motivoDevolucion: "Producto defectuoso",
                        estadoDevolucion: "En tr√°nsito al vendedor",
                        productosDevueltos: [{ sku: "LIB-ECO-R", nombre: "Libreta Ecol√≥gica", cantidad: 1 }]
                    }
                ];
                guardarDatosDevoluciones();
            }
        }
        function guardarDatosDevoluciones() { localStorage.setItem('devolucionesDataGlobal', JSON.stringify(window.devolucionesDataGlobal)); }

        function cargarVistaDevoluciones() {
            const container = document.getElementById('lista-devoluciones-container');
            if (!container) return;
            inicializarDatosDevoluciones(); container.innerHTML = '';
            if (window.devolucionesDataGlobal.length === 0) { container.innerHTML = '<p>No hay devoluciones para mostrar.</p>'; return; }
            const ordenadas = [...window.devolucionesDataGlobal].sort((a,b) => {
                const activaA = !['Procesada (Stock Reingresado)', 'Procesada (Items Descartados)', 'Reembolso procesado', 'Cerrada', 'Cancelada'].includes(a.estadoDevolucion);
                const activaB = !['Procesada (Stock Reingresado)', 'Procesada (Items Descartados)', 'Reembolso procesado', 'Cerrada', 'Cancelada'].includes(b.estadoDevolucion);
                if (activaA !== activaB) return activaA ? -1 : 1;
                return new Date(b.fechaInicioDevolucion) - new Date(a.fechaInicioDevolucion);
            });
            ordenadas.forEach(dev => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'devolucion-item'; itemDiv.id = `dev-${dev.devolucionId}`;
                let prodsHTML = '<ul class="devolucion-productos-lista">' + dev.productosDevueltos.map(p => `<li>${p.nombre} (SKU:${p.sku}) - Cant:${p.cantidad}</li>`).join('') + '</ul>';
                const estadoClase = dev.estadoDevolucion.replace(/\s+/g, '').replace(/[()]/g, '');
                let btnsAccion = '';
                if (['Recibida por el vendedor', 'Inspecci√≥n completada'].includes(dev.estadoDevolucion)) {
                    btnsAccion = `<button onclick="reingresarStockDevolucion('${dev.devolucionId}')" class="action-button action-button-success">Marcar como Procesada (Items OK)</button> <button onclick="descartarProductosDevolucion('${dev.devolucionId}')" class="action-button action-button-danger">Marcar como Procesada (Items Da√±ados)</button>`;
                }
                itemDiv.innerHTML = `<p><strong>ID Devoluci√≥n:</strong> ${dev.devolucionId}</p><p><strong>Pedido Original:</strong> <a href="#" onclick="alert('Funcionalidad Ver Pedido Original no implementada: ${dev.orderIdOriginal}')">${dev.orderIdOriginal}</a> (Cliente: ${dev.clienteNombre})</p><p><strong>Fecha Inicio:</strong> ${new Date(dev.fechaInicioDevolucion).toLocaleDateString('es-AR')} - <strong>Motivo:</strong> ${dev.motivoDevolucion}</p><p><strong>Productos Devueltos:</strong></p>${prodsHTML}<p><strong>Estado Actual:</strong> <span class="estado-devolucion estado-${estadoClase}">${dev.estadoDevolucion}</span></p><div class="item-acciones"><label for="estado-dev-${dev.devolucionId}">Cambiar Estado:</label><select id="estado-dev-${dev.devolucionId}" onchange="cambiarEstadoDevolucion('${dev.devolucionId}', this.value)">${ESTADOS_DEVOLUCION.map(e => `<option value="${e}" ${e===dev.estadoDevolucion ? 'selected':''}>${e}</option>`).join('')}</select>${btnsAccion}</div>`;
                container.appendChild(itemDiv);
            });
            actualizarDashboard();
        }

        function cambiarEstadoDevolucion(devolucionId, nuevoEstado) {
            const dev = window.devolucionesDataGlobal.find(d => d.devolucionId === devolucionId);
            if (dev) {
                if ((nuevoEstado === "Procesada (Stock Reingresado)" || nuevoEstado === "Procesada (Items Descartados)") && !['Recibida por el vendedor', 'Inspecci√≥n completada'].includes(dev.estadoDevolucion) && dev.estadoDevolucion !== nuevoEstado) {
                    alert(`Para cambiar a "${nuevoEstado}", el estado actual debe ser "Recibida por el vendedor" o "Inspecci√≥n completada" y debes usar los botones de acci√≥n espec√≠ficos.`);
                    cargarVistaDevoluciones(); return; 
                }
                dev.estadoDevolucion = nuevoEstado;
                console.log(`Estado de devoluci√≥n ${devolucionId} cambiado a: ${nuevoEstado}`);
                guardarDatosDevoluciones(); cargarVistaDevoluciones();
            }
        }

        function reingresarStockDevolucion(devolucionId) {
            const dev = window.devolucionesDataGlobal.find(d => d.devolucionId === devolucionId);
            if (!dev || !confirm(`¬øConfirmas que los productos de la devoluci√≥n ${devolucionId} est√°n en condiciones y quieres marcarla como "Procesada (Stock Reingresado)"? Esto NO afectar√° el inventario num√©rico en este sistema.`)) return;
            
            dev.estadoDevolucion = "Procesada (Stock Reingresado)";
            alert(`Devoluci√≥n ${devolucionId} marcada como "Procesada (Stock Reingresado)".\nRecuerda ajustar tu inventario manualmente si es necesario.`);
            
            guardarDatosDevoluciones(); 
            cargarVistaDevoluciones();
        }

        function descartarProductosDevolucion(devolucionId) {
            const dev = window.devolucionesDataGlobal.find(d => d.devolucionId === devolucionId);
            if (!dev || !confirm(`¬øConfirmas que los productos de la devoluci√≥n ${devolucionId} NO est√°n en condiciones y deben ser marcados como "Procesada (Items Descartados)"? Esto NO afectar√° el inventario num√©rico en este sistema.`)) return;
            
            dev.estadoDevolucion = "Procesada (Items Descartados)";
            alert(`Devoluci√≥n ${devolucionId} marcada como "Procesada (Items Descartados)".\nRecuerda ajustar tu inventario manualmente si es necesario.`);
            
            guardarDatosDevoluciones(); 
            cargarVistaDevoluciones();
        }

        function sincronizarCancelacionesConML() {
            if (!window.pedidosCanceladosPorMLSimulado || window.pedidosCanceladosPorMLSimulado.length === 0) {
                alert("No hay IDs de pedidos en 'window.pedidosCanceladosPorMLSimulado' para simular cancelaciones desde MercadoLibre.\nEdita esta variable en el c√≥digo fuente (dentro del tag <script>) para probar.");
                return;
            }

            let cambiosRealizados = false;
            let resumenSincronizacion = "Resumen de Sincronizaci√≥n de Cancelaciones:\n\n";
            const fechaCancelacionActual = new Date().toISOString();

            window.pedidosCanceladosPorMLSimulado.forEach(idPedidoCanceladoML => {
                idPedidoCanceladoML = idPedidoCanceladoML.trim().toUpperCase();
                let yaCanceladoEnSistema = false;
                let encontradoYActualizadoEsteCiclo = false;

                // 1. Revisar y actualizar pedidos pendientes
                if (window.pedidosDataGlobal[idPedidoCanceladoML]) {
                    const pedidoPendiente = window.pedidosDataGlobal[idPedidoCanceladoML];
                    if (!pedidoPendiente.esCancelado) {
                        pedidoPendiente.esCancelado = true;
                        pedidoPendiente.fechaCancelacion = fechaCancelacionActual;
                        resumenSincronizacion += `- Pedido pendiente ${idPedidoCanceladoML} marcado como cancelado.\n`;
                        encontradoYActualizadoEsteCiclo = true;
                        cambiosRealizados = true;
                    } else {
                        yaCanceladoEnSistema = true; 
                    }
                }

                // 2. Revisar y actualizar pedidos en historial
                for (const fecha in window.historialPedidosGlobal) {
                    const pedidoHist = window.historialPedidosGlobal[fecha].find(p => p.id === idPedidoCanceladoML);
                    if (pedidoHist) {
                        if (!pedidoHist.esCancelado) {
                            pedidoHist.esCancelado = true;
                            pedidoHist.fechaCancelacion = fechaCancelacionActual;
                            resumenSincronizacion += `- Pedido del historial ${idPedidoCanceladoML} (empaquetado el ${fecha}) marcado como cancelado.\n`;
                            encontradoYActualizadoEsteCiclo = true;
                            cambiosRealizados = true;
                        } else {
                             yaCanceladoEnSistema = true; 
                        }
                        break; 
                    }
                }
                
                if (!encontradoYActualizadoEsteCiclo && !yaCanceladoEnSistema && window.pedidosDataGlobal[idPedidoCanceladoML] === undefined && !Object.values(window.historialPedidosGlobal).flat().find(p=>p.id === idPedidoCanceladoML) ) {
                     resumenSincronizacion += `- Pedido ${idPedidoCanceladoML} (de la lista simulada de ML) no fue encontrado en el sistema.\n`;
                } else if (yaCanceladoEnSistema && !encontradoYActualizadoEsteCiclo) {
                    resumenSincronizacion += `- Pedido ${idPedidoCanceladoML} ya se encontraba cancelado en el sistema (o fue actualizado en este mismo ciclo si estaba en pendientes e historial).\n`;
                }
            });

            if (cambiosRealizados) {
                guardarPedidosDataGlobal();
                guardarHistorialPedidosGlobal();
                popularListasDePedidosPendientes(); // Actualizar listas de pendientes en la UI
                if (document.getElementById('historial-pedidos').style.display === 'block') {
                    cargarHistorial(); // Recargar vista de historial si est√° activa
                }
                actualizarDashboard();
                checkForRecentCancellations();
                resumenSincronizacion += "\nSincronizaci√≥n completada. Revisa los cambios.";
            } else {
                resumenSincronizacion += "\nNo se realizaron nuevos cambios en el estado de los pedidos a partir de la lista simulada de ML (posiblemente ya estaban cancelados o no se encontraron).";
            }
            alert(resumenSincronizacion);
            console.log(resumenSincronizacion);
        }
        
        function cargarHistorial() {
            const fechaInput = document.getElementById('fecha-historial');
            const resultadosDiv = document.getElementById('lista-historial-resultados');
            const accionesDiv = document.getElementById('acciones-historial-dia');
            const resumenProductosDiv = document.getElementById('resumen-productos-dia-resultados');
            if (!fechaInput || !resultadosDiv || !accionesDiv || !resumenProductosDiv) return;

            const fechaSeleccionada = fechaInput.value;
            if (!fechaSeleccionada) {
                resultadosDiv.innerHTML = "<p>Por favor, seleccione una fecha.</p>";
                accionesDiv.style.display = 'none';
                resumenProductosDiv.innerHTML = '';
                return;
            }

            const pedidosDelDia = window.historialPedidosGlobal[fechaSeleccionada] || [];
            resultadosDiv.innerHTML = ''; 
            resumenProductosDiv.innerHTML = ''; 

            if (pedidosDelDia.length === 0) {
                resultadosDiv.innerHTML = `<p>No hay pedidos empaquetados para la fecha ${fechaSeleccionada}.</p>`;
                accionesDiv.style.display = 'none';
            } else {
                resultadosDiv.innerHTML = `<h3>Pedidos Empaquetados el ${fechaSeleccionada} (${pedidosDelDia.filter(p => !p.esCancelado).length} Activos / ${pedidosDelDia.filter(p => p.esCancelado).length} Cancelados):</h3>`;
                pedidosDelDia.forEach(pedido => {
                    const pedidoDiv = document.createElement('div');
                    pedidoDiv.className = `pedido-historial-item ${pedido.esCancelado ? 'cancelado' : ''}`; 
                    let productosHtml = '<ul>';
                    pedido.productos.forEach(p => {
                        productosHtml += `<li>${p.nombre} (SKU: ${p.sku}) - Cantidad: ${p.pedida}</li>`;
                    });
                    productosHtml += '</ul>';
                    
                    let estadoCancelacionHtml = '';
                    if (pedido.esCancelado) {
                        estadoCancelacionHtml = `<p style="color: #c0392b; font-weight: bold;">‚ö†Ô∏è VENTA CANCELADA ${pedido.fechaCancelacion ? `el ${new Date(pedido.fechaCancelacion).toLocaleDateString('es-AR')}` : '(Fecha no registrada)'}</p>`;
                    }

                    pedidoDiv.innerHTML = `
                        ${estadoCancelacionHtml}
                        <p><strong>ID Pedido:</strong> ${pedido.id}</p>
                        <p><strong>Cliente:</strong> ${pedido.cliente}</p>
                        <p><strong>Tipo Env√≠o:</strong> ${pedido.tipoEnvio}</p>
                        <p><strong>Empaquetado por:</strong> ${pedido.empaquetadoPor || 'No registrado'}</p>
                        <p><strong>Estado Stock Anterior:</strong> ${pedido.stockDescontadoConfirmado ? 'Confirmado (Sistema Anterior)' : 'No Confirmado (Sistema Anterior)'}</p>
                        <p><strong>Productos (${pedido.itemsCount}):</strong></p>
                        ${productosHtml}
                        ${pedido.notaInterna ? `<p><strong>Nota Interna:</strong> ${pedido.notaInterna}</p>` : ''}
                        <div class="item-acciones">
                            <button class="action-button action-button-secondary" onclick="verDetallesPedidoHistorial('${fechaSeleccionada}', '${pedido.id}')">Ver Detalles (Consola)</button>
                        </div>
                    `;
                    resultadosDiv.appendChild(pedidoDiv);
                });
                accionesDiv.style.display = 'block';
            }
        }
        
        function verDetallesPedidoHistorial(fecha, idPedido) {
            const pedido = (window.historialPedidosGlobal[fecha] || []).find(p => p.id === idPedido);
            if (pedido) {
                console.log("Detalles del Pedido (Historial):", pedido);
                alert(`Los detalles del pedido ${idPedido} (de fecha ${fecha}) se han mostrado en la consola del navegador (F12).`);
            } else {
                alert(`No se encontr√≥ el pedido ${idPedido} para la fecha ${fecha} en el historial.`);
                console.warn(`No se encontr√≥ el pedido ${idPedido} para la fecha ${fecha} en el historial.`);
            }
        }

        function mostrarResumenProductosDia() {
            const fechaSeleccionada = document.getElementById('fecha-historial').value;
            const resultadosDiv = document.getElementById('resumen-productos-dia-resultados');
            if (!fechaSeleccionada || !resultadosDiv) {
                if(resultadosDiv) resultadosDiv.innerHTML = "<p>Seleccione una fecha primero.</p>";
                return;
            }
            const pedidosDelDia = (window.historialPedidosGlobal[fechaSeleccionada] || []).filter(p => !p.esCancelado);
            if (pedidosDelDia.length === 0) {
                resultadosDiv.innerHTML = "<p>No hay pedidos activos para resumir en esta fecha.</p>";
                return;
            }

            const resumen = {};
            pedidosDelDia.forEach(pedido => {
                pedido.productos.forEach(producto => {
                    if (!resumen[producto.sku]) {
                        resumen[producto.sku] = { nombre: producto.nombre, cantidadTotal: 0, pedidosIds: [] };
                    }
                    resumen[producto.sku].cantidadTotal += producto.pedida;
                    if (!resumen[producto.sku].pedidosIds.includes(pedido.id)) {
                        resumen[producto.sku].pedidosIds.push(pedido.id);
                    }
                });
            });

            if (Object.keys(resumen).length === 0) {
                resultadosDiv.innerHTML = "<p>No se encontraron productos en los pedidos activos de esta fecha.</p>";
                return;
            }

            let htmlResumen = `<h3>Resumen de Productos Vendidos (Pedidos Activos) el ${fechaSeleccionada}:</h3><table><thead><tr><th>SKU</th><th>Producto</th><th>Cantidad Total Vendida</th><th>En Pedidos N¬∞</th></tr></thead><tbody>`;
            for (const sku in resumen) {
                const item = resumen[sku];
                htmlResumen += `<tr><td>${sku}</td><td>${item.nombre}</td><td>${item.cantidadTotal}</td><td>${item.pedidosIds.join(', ')}</td></tr>`;
            }
            htmlResumen += "</tbody></table>";
            resultadosDiv.innerHTML = htmlResumen;
        }


        document.addEventListener('DOMContentLoaded', (event) => {
            const elFechaHistorial = document.getElementById('fecha-historial');
            if (elFechaHistorial) {
                const today = new Date();
                elFechaHistorial.value = `${today.getFullYear()}-${('0' + (today.getMonth() + 1)).slice(-2)}-${('0' + today.getDate()).slice(-2)}`;
            }
            const historialGuardado = localStorage.getItem('historialPedidosGlobal');
            if (historialGuardado) window.historialPedidosGlobal = JSON.parse(historialGuardado);
           
            const pedidosGuardadosLocal = localStorage.getItem('pedidosDataGlobal');
            if (pedidosGuardadosLocal) { 
                window.pedidosDataGlobal = JSON.parse(pedidosGuardadosLocal);
                Object.values(window.pedidosDataGlobal).forEach(p => {
                    if (p.esCancelado === undefined) p.esCancelado = false;
                    if (p.fechaCancelacion === undefined) p.fechaCancelacion = null;
                });
            } else {
                 pedidosSimuladosBase.forEach(p => {
                    p.productos.forEach(prod => prod.verificada = 0); 
                    window.pedidosDataGlobal[p.id] = JSON.parse(JSON.stringify({ 
                        ...p, 
                        empaquetado: false, 
                        fechaCompletado: null, 
                        empaquetadoPor: null, 
                        stockDescontadoConfirmado: false,
                        esCancelado: p.esCancelado || false, 
                        fechaCancelacion: p.fechaCancelacion || null 
                    }));
                });
                guardarPedidosDataGlobal();
            }
            for (const fecha in window.historialPedidosGlobal) {
                window.historialPedidosGlobal[fecha].forEach(p => {
                    if (p.esCancelado === undefined) p.esCancelado = false;
                    if (p.fechaCancelacion === undefined) p.fechaCancelacion = null;
                });
            }

            cargarConfiguracionEmpaquetadores();
            inicializarDatosDevoluciones(); 
            popularListasDePedidosPendientes(); 
            popularSelectsPlantillas(); 
            cargarPreguntasSinResponder(); 
            cargarConversacionesPostventa(); 
           
            mostrarSeccion('dashboard-wrapper'); 

            document.getElementById('completar-empaque-btn')?.addEventListener('click', finalizarPedidoActual);
            document.getElementById('filtro-preguntas')?.addEventListener('input', filtrarListaPreguntas);
            document.getElementById('barcode-scanner')?.addEventListener('keypress', function(e) { 
                 if (e.key === 'Enter') {
                    e.preventDefault();
                    const scannedValue = this.value.trim().toUpperCase();
                    if (scannedValue === "") return;
                    const idPedidoActual = document.getElementById('id-pedido-actual').textContent;
                    if (!idPedidoActual || !window.pedidosDataGlobal[idPedidoActual]) {
                         alert("No hay pedido activo para escanear productos."); this.value = ''; return;
                    }
                    const pedido = window.pedidosDataGlobal[idPedidoActual];
                    const productoEncontrado = pedido.productos.find(p => p.sku.toUpperCase() === scannedValue && (p.verificada || 0) < p.pedida);
                    if (productoEncontrado) {
                        const filaProducto = document.querySelector(`#tabla-productos-tbody tr[data-item-id="${productoEncontrado.id_instancia_pedido}"]`);
                        if (filaProducto) {
                            const botonVerificar = filaProducto.querySelector('button.action-button:not(:disabled)');
                            if (botonVerificar) {
                                verificarItemConClick(botonVerificar, productoEncontrado.id_instancia_pedido);
                            } else {
                                console.warn(`Producto ${productoEncontrado.nombre} (SKU: ${scannedValue}) encontrado, pero su bot√≥n de verificaci√≥n no est√° activo o no se encontr√≥.`);
                                alert(`El producto ${productoEncontrado.nombre} (SKU: ${scannedValue}) ya ha sido completamente verificado para este pedido o hay un problema con su bot√≥n de verificaci√≥n.`);
                            }
                        } else {
                             console.error(`No se encontr√≥ la fila para el producto con id_instancia_pedido: ${productoEncontrado.id_instancia_pedido} (SKU: ${scannedValue})`);
                             alert(`Se encontr√≥ el producto con SKU ${scannedValue} pero no su fila en la tabla.`);
                        }
                    } else {
                        alert(`SKU "${scannedValue}" no encontrado en este pedido, o ya ha sido completamente verificado.`);
                    }
                    this.value = ''; this.focus();
                }
            });
            
            console.log("Sistema de Verificaci√≥n de Empaques y Gesti√≥n ML inicializado (con SINCRONIZACI√ìN simulada de cancelaci√≥n).");
        });
    </script>
</body>
</html>