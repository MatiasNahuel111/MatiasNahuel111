<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación de Pedidos y Gestión - Mercado Libre</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        header { margin-bottom: 15px; text-align: center; }
        header h1 { color: #2c3e50; font-weight: 600;}
        nav { margin-bottom: 25px; border-bottom: 2px solid #3498db; padding-bottom: 12px; text-align: center; flex-wrap: wrap; display: flex; justify-content: center;}
        nav button {
            padding: 10px 18px; margin: 5px 6px; cursor: pointer; background-color: #3498db;
            color: white; border: none; border-radius: 5px; font-size: 0.95em; font-weight: 500;
            transition: background-color 0.2s ease;
        }
        nav button:hover { background-color: #2980b9; }
        .container { max-width: 1000px; margin: auto; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
        th, td { border: 1px solid #dfe6e9; padding: 12px; text-align: left; vertical-align: top; }
        th { background-color: #eaf2f8; color: #34495e; font-weight: 600; }
        td img { vertical-align: middle; margin-right: 5px; max-width: 50px; max-height:50px; border-radius:3px; }
        .scan-input { padding: 10px; margin-bottom: 20px; box-sizing: border-box; border: 1px solid #b2bec3; border-radius: 4px; width: calc(100% - 24px); }
        .action-button { padding: 8px 14px; cursor: pointer; background-color: #5dade2; color: white; border: none; border-radius: 4px; margin-right: 6px; font-size:0.9em; }
        .action-button:hover { background-color: #3498db; }
        .action-button-secondary { background-color: #7f8c8d; }
        .action-button-secondary:hover { background-color: #6c7a89; }
        .action-button-danger { background-color: #e74c3c; }
        .action-button-danger:hover { background-color: #c0392b; }
        .action-button-warning { background-color: #f39c12; }
        .action-button-warning:hover { background-color: #e67e22; }
        .action-button-success { background-color: #2ecc71; }
        .action-button-success:hover { background-color: #27ae60; }

        .complete-button { padding: 12px 20px; background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.05em; font-weight: 500;}
        .complete-button:hover { background-color: #27ae60; }
        .complete-button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .order-list-item { padding: 12px 15px; border: 1px solid #ecf0f1; margin-bottom: 10px; cursor: pointer; border-radius: 5px; background-color: #fdfefe; transition: background-color 0.2s ease;}
        .order-list-item:hover { background-color: #e9f5fe; }
        .order-list-item.cancelado-pendiente { background-color: #ffebee !important; border-left: 4px solid #c0392b; }
        .order-list-item strong { color: #2980b9; }
        .section-title { color: #34495e; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; margin-top: 15px; margin-bottom: 20px; font-size: 1.4em; font-weight: 600;}
        #acciones-historial-dia { border-top: 1px dashed #dfe6e9; padding-top: 15px; margin-top:20px;}
       
        #verificacion-actual-wrapper, #historial-pedidos, #preguntas-wrapper, #mensajes-postventa-wrapper, #dashboard-wrapper, #configuracion-wrapper, #devoluciones-wrapper { display: none; }
        #acciones-historial-dia {display: none;}
        #verificacion-pedido {display: none;}

        .categoria-pedidos { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; background-color: #f9f9f9; }
        .categoria-pedidos h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 8px; font-size: 1.2em; }
        .lista-especifica p { font-style: italic; color: #7f8c8d; padding: 10px 0; }

        .pregunta-item, .conversacion-item, .devolucion-item { border: 1px solid #dfe6e9; padding: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #fdfefe; overflow: auto;  position: relative; }
        .pregunta-item strong, .conversacion-item strong, .devolucion-item strong { color: #2c3e50; }
        .pregunta-item img { max-width: 60px; float: left; margin-right: 15px; border: 1px solid #eee; border-radius: 4px;}
        .pregunta-item .pregunta-info { margin-left: 75px; }
        .pregunta-item .pregunta-info p, .conversacion-item p, .devolucion-item p { margin: 5px 0; }
        .pregunta-item .pregunta-texto { font-style: italic; margin-bottom: 8px; }
        .pregunta-item .pregunta-meta, .conversacion-item .conversacion-meta, .devolucion-item .devolucion-meta { font-size: 0.85em; color: #7f8c8d; margin-bottom: 10px; }
        .pregunta-item textarea, .modal-contenido textarea { width: calc(100% - 22px); padding:10px; min-height: 60px; margin-top: 10px; margin-bottom: 10px; border:1px solid #b2bec3; border-radius:4px; box-sizing: border-box;}
       
        .notif-badge { background-color: #e74c3c; color: white; border-radius: 10px; padding: 2px 7px; font-size: 0.75em; margin-left: 5px; display: inline-block; vertical-align: middle; font-weight: bold; line-height: 1; }

        #historial-pedidos label, #configuracion-wrapper label { margin-right: 10px; font-weight:500; }
        #historial-pedidos input[type="date"], #configuracion-wrapper input[type="text"], #configuracion-wrapper select { padding: 8px; border-radius: 4px; border: 1px solid #b2bec3; margin-right:5px; }
        .pedido-historial-item { border: 1px solid #e0e0e0; padding: 15px; margin-top: 15px; border-radius: 6px; background-color: #f9f9f9; }
        .pedido-historial-item.cancelado { background-color: #ffebee !important; border-left: 5px solid #c0392b; } 
        .pedido-historial-item strong { color: #2c3e50; }
        #lista-historial-resultados p, #resumen-productos-dia-resultados p, #lista-conversaciones-postventa p, #lista-preguntas p, #lista-devoluciones-container p {font-style: italic; color: #7f8c8d;}

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-contenido { background-color: #fff; margin: auto; padding: 25px; border: 1px solid #b2bec3; border-radius: 8px; width: 85%; max-width: 650px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dfe6e9; padding-bottom: 10px; margin-bottom: 15px;}
        .modal-header h3 { margin: 0; font-size: 1.3em; color: #2c3e50;}
        .modal-cerrar { cursor: pointer; font-size: 28px; font-weight: bold; color: #7f8c8d;}
        .modal-cerrar:hover { color: #2c3e50; }
        .chat-area { height: 300px; overflow-y: auto; border: 1px solid #dfe6e9; padding: 15px; margin-bottom: 15px; background-color: #f9fafb; border-radius: 4px;}
        .mensaje { margin-bottom: 12px; line-height: 1.4; }
        .mensaje p { display: inline-block; padding: 10px 14px; border-radius: 15px; max-width: 75%; margin: 0;}
        .mensaje-recibido p { background-color: #e9ecef; color: #343a40; border-top-left-radius: 0;}
        .mensaje-enviado { text-align: right; }
        .mensaje-enviado p { background-color: #007bff; color: white; border-top-right-radius: 0;}
        .mensaje-meta { font-size: 0.8em; color: #7f8c8d; display: block; margin-top: 4px; }
        .mensaje-recibido .mensaje-meta { text-align: left; }
        .mensaje-enviado .mensaje-meta { text-align: right; }
        .item-no-leido { font-weight:bold; border-left: 4px solid #e74c3c !important; background-color: #fff3f3 !important;}
        .item-leido { font-weight:normal; border-left: 4px solid #bdc3c7 !important; background-color: #fdfefe !important; }
        .item-leido small, .item-leido .pregunta-meta { font-weight: normal !important; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .dashboard-card { background-color: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-card h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-size: 1.1em; }
        .dashboard-metric { font-size: 2.5em; font-weight: bold; color: #2980b9; margin: 0; }
        .dashboard-card.warning h4 { color: #c0392b; } 
        .dashboard-card.warning .dashboard-metric { color: #e74c3c; }

        .notas-internas-pedido { margin-top: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; background-color: #fdfdff; }
        .notas-internas-pedido h4 { margin-top: 0; margin-bottom: 10px; color: #34495e; font-size: 1.1em; }
        .notas-internas-pedido textarea { width: calc(100% - 22px); min-height: 70px; padding: 10px; border: 1px solid #b2bec3; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
        .detalle-producto-adicional { font-size: 0.9em; color: #555; }
        .detalle-producto-adicional strong { color: #333; }

        .contenedor-respuesta .select-plantilla { display: block; width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #b2bec3; border-radius: 4px; box-sizing: border-box; background-color: #fff; }
        .pregunta-item .contenedor-respuesta, .modal-contenido .contenedor-respuesta { margin-top: 10px; }
        .item-acciones { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;}
        .item-acciones > * { margin-bottom: 5px; }

        /* Configuración Empaquetadores */
        .config-section { margin-bottom: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 6px; background-color: #f9f9f9;}
        .config-section h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 8px;}
        #lista-empaquetadores-actuales { margin-top: 10px; list-style:decimal; padding-left:20px;}
        #lista-empaquetadores-actuales li {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        #lista-empaquetadores-actuales li button {
            margin-left: 15px;
            padding: 4px 8px;
            font-size: 0.85em;
        }
        #empaquetador-activo-info { margin-top: 15px; margin-bottom:15px; padding: 10px; background-color: #eaf2f8; border-radius: 4px; color: #34495e; font-weight: bold; }
        #empaquetador-activo-info.no-seleccionado { background-color: #fadbd8; color: #c0392b;}

        /* Devoluciones */
        .devolucion-productos-lista { list-style: disc; padding-left: 20px; margin-top:5px; }
        .devolucion-productos-lista li { font-size: 0.9em; }
        .devolucion-item .estado-devolucion { font-weight: bold; }
        .estado-Iniciada { color: #3498db; }
        .estado-EnTransitoAlVendedor { color: #f39c12; }
        .estado-RecibidaPorElVendedor { color: #27ae60; }
        .estado-InspecciónCompletada { color: #16a085; }
        .estado-ProcesadaStockReingresado { color: #2ecc71; }
        .estado-ProcesadaItemsDescartados { color: #e74c3c; }
        .estado-ReembolsoProcesado { color: #2ecc71; }
        .estado-Cerrada { color: #7f8c8d; }
        .estado-Cancelada { color: #c0392b; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Sistema de Verificación de Empaques y Gestión ML</h1></header>
        <nav>
            <button onclick="mostrarSeccion('dashboard-wrapper')">📊 Dashboard</button>
            <button onclick="mostrarSeccion('verificacion-actual-wrapper')">Verificación Actual</button>
            <button onclick="mostrarSeccion('preguntas-wrapper')">Preguntas <span id="notif-badge-preguntas" class="notif-badge" style="display:none;">0</span></button>
            <button onclick="mostrarSeccion('mensajes-postventa-wrapper')">Mensajes Post-Venta <span id="notif-badge-postventa" class="notif-badge" style="display:none;">0</span></button>
            <button onclick="mostrarSeccion('devoluciones-wrapper')">↩️ Devoluciones</button>
            <button onclick="mostrarSeccion('historial-pedidos')">Historial Pedidos</button>
            <button onclick="mostrarSeccion('configuracion-wrapper')">⚙️ Configuración</button>
        </nav>

        <!-- Contenido de las secciones -->
        <div id="dashboard-wrapper">
            <h2 class="section-title">📊 Resumen del Día</h2>
             <div id="empaquetador-activo-info" class="no-seleccionado">Empaquetador Activo: Ninguno seleccionado. Por favor, ve a Configuración.</div>
            <div class="dashboard-grid">
                <div class="dashboard-card"><h4>Pedidos Empaquetados Hoy (Neto)</h4><p class="dashboard-metric" id="db-pedidos-empaquetados">-</p></div>
                <div class="dashboard-card warning"><h4>⚠️ Cancelados Post-Empaque Hoy</h4><p class="dashboard-metric" id="db-cancelados-post-empaque-hoy">-</p></div>
                <div class="dashboard-card"><h4>Preguntas Pendientes</h4><p class="dashboard-metric" id="db-preguntas-pendientes">-</p></div>
                <div class="dashboard-card"><h4>Mensajes Nuevos</h4><p class="dashboard-metric" id="db-mensajes-nuevos">-</p></div>
                <div class="dashboard-card"><h4>Devoluciones Activas</h4><p class="dashboard-metric" id="db-devoluciones-activas">-</p></div>
                <div class="dashboard-card"><h4>Pedidos TURBO</h4><p class="dashboard-metric" id="db-turbo-pendientes">-</p></div>
                <div class="dashboard-card"><h4>Pedidos FLEX</h4><p class="dashboard-metric" id="db-flex-pendientes">-</p></div>
                <div class="dashboard-card"><h4>📬 Pedidos CORREO</h4><p class="dashboard-metric" id="db-correo-pendientes">-</p></div>
                <div class="dashboard-card"><h4>🚶 Retiros Persona</h4><p class="dashboard-metric" id="db-retiros-pendientes">-</p></div>
                <div class="dashboard-card"><h4>Total Pendientes Empaque</h4><p class="dashboard-metric" id="db-total-pendientes">-</p></div>
            </div>
             <div id="aviso-cancelados-recientes" style="margin-top: 20px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px; display:none;">
                <strong>Atención:</strong> Se han detectado pedidos empaquetados previamente que ahora figuran como cancelados. Revisa el historial.
            </div>
        </div>

        <div id="verificacion-actual-wrapper">
             <section id="lista-pedidos">
                <h2 class="section-title">Pedidos Pendientes de Verificación</h2>
                <div class="categoria-pedidos" id="cat-turbo"><h3>⚡ Pedidos TURBO</h3><div id="pedidos-turbo-list" class="lista-especifica"><p>Cargando...</p></div></div>
                <div class="categoria-pedidos" id="cat-flex"><h3>🛵 Pedidos FLEX</h3><div id="pedidos-flex-list" class="lista-especifica"><p>Cargando...</p></div></div>
                <div class="categoria-pedidos" id="cat-correo"><h3>📬 Pedidos CORREO</h3><div id="pedidos-correo-list" class="lista-especifica"><p>Cargando...</p></div></div>
                <div class="categoria-pedidos" id="cat-retiro"><h3>🚶 Pedidos RETIRO EN PERSONA</h3><div id="pedidos-retiro-list" class="lista-especifica"><p>Cargando...</p></div></div>
            </section>
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #dfe6e9;">
            <section id="verificacion-pedido">
                <h2 class="section-title">Verificando Pedido: <span id="id-pedido-actual"></span></h2>
                <div><label for="barcode-scanner" style="font-weight:500; display:block; margin-bottom:5px;">Escanear Código (SKU):</label><input type="text" id="barcode-scanner" class="scan-input" placeholder="Esperando escaneo..."></div>
                <h3>Productos del Pedido:</h3>
                <table>
                    <thead><tr><th>Imagen</th><th>Nombre</th><th>SKU/Variante</th><th>Ubicación/Notas Prod.</th><th>Cant. Pedida</th><th>Cant. Verificada</th><th>Acción</th></tr></thead>
                    <tbody id="tabla-productos-tbody"></tbody>
                </table>
                <div><p><strong>Progreso:</strong> <span id="progreso-verificacion">- de -</span></p><p><strong>Items Completos:</strong> <span id="items-completos">- de -</span>.</p></div>
                <div class="notas-internas-pedido"><h4>Notas Internas:</h4><textarea id="nota-interna-pedido" placeholder="Añade notas..."></textarea><button onclick="guardarNotaInterna()" class="action-button" style="margin-top:10px; background-color:#3498db;">Guardar Nota</button></div>
                <button id="completar-empaque-btn" class="complete-button" style="margin-top:20px;" disabled>Empaque Completo</button>
            </section>
        </div>
        <div id="preguntas-wrapper">
            <h2 class="section-title">Preguntas Pendientes</h2>
            <div style="margin-bottom: 15px;"><label for="filtro-preguntas" style="font-weight:500; margin-right: 10px;">Buscar:</label><input type="text" id="filtro-preguntas" class="scan-input" style="width: calc(100% - 120px); margin-bottom:0; display:inline-block; vertical-align: middle;" placeholder="Filtrar..."></div>
            <div id="lista-preguntas"><p>Cargando preguntas...</p></div>
        </div>
        <div id="mensajes-postventa-wrapper">
            <h2 class="section-title">Mensajes Post-Venta</h2>
            <div id="lista-conversaciones-postventa"><p>Cargando conversaciones...</p></div>
        </div>

        <div id="devoluciones-wrapper">
            <h2 class="section-title">↩️ Devoluciones en Proceso</h2>
            <div id="lista-devoluciones-container"><p>Cargando devoluciones...</p></div>
        </div>

        <div id="configuracion-wrapper">
            <h2 class="section-title">⚙️ Configuración General</h2>
            <div class="config-section">
                <h3>Gestión de Empaquetadores</h3>
                <div>
                    <label for="nuevo-empaquetador-nombre">Nuevo Empaquetador:</label>
                    <input type="text" id="nuevo-empaquetador-nombre" placeholder="Nombre del empaquetador">
                    <button onclick="agregarEmpaquetador()" class="action-button">Agregar</button>
                </div>
                <div style="margin-top: 15px;">
                    <label for="select-empaquetador-activo">Seleccionar Empaquetador Activo:</label>
                    <select id="select-empaquetador-activo" onchange="seleccionarEmpaquetadorActivo(this.value)">
                        <option value="">-- Ninguno --</option>
                    </select>
                </div>
                <h4>Empaquetadores Actuales:</h4>
                <ul id="lista-empaquetadores-actuales"><p>No hay empaquetadores registrados.</p></ul>
            </div>
             <div class="config-section"> 
                <h3>Sincronización de Cancelaciones (Simulado)</h3>
                <p style="font-size:0.9em; color:#555;">Para simular cancelaciones detectadas desde MercadoLibre, debes modificar el array <code>window.pedidosCanceladosPorMLSimulado</code> directamente en el código fuente de esta página (dentro de la etiqueta <code><script></code>). Añade los IDs de los pedidos que deseas simular como cancelados por ML. Luego, presiona el botón de abajo.</p>
                <button onclick="sincronizarCancelacionesConML()" class="action-button action-button-warning">Sincronizar Cancelaciones con ML (Simulado)</button>
            </div>
        </div>
        <section id="historial-pedidos">
            <h2 class="section-title">Historial de Pedidos</h2>
            <div><label for="fecha-historial">Fecha:</label><input type="date" id="fecha-historial" name="fecha-historial"><button onclick="cargarHistorial()" class="action-button">Ver Historial</button></div>
            <div id="lista-historial-resultados" style="margin-top: 20px;"><p>Seleccione fecha.</p></div>
            <div id="acciones-historial-dia"><button onclick="mostrarResumenProductosDia()" class="action-button">Resumen Productos Vendidos</button></div>
            <div id="resumen-productos-dia-resultados" style="margin-top: 20px;"></div>
        </section>
    </div>

    <div id="modal-mensajes-postventa" class="modal">
        <div class="modal-contenido">
            <div class="modal-header"><h3>Mensajes Pedido: <span id="postventa-pedido-id-modal"></span></h3><span class="modal-cerrar" onclick="cerrarModalMensajesPostventa()">×</span></div>
            <div id="chat-postventa-area" class="chat-area"><p>Cargando...</p></div>
            <div class="contenedor-respuesta"><select class="select-plantilla" id="plantillas-postventa" onchange="aplicarPlantilla(this, 'postventa-respuesta-texto')"><option value="">Plantilla...</option></select><textarea id="postventa-respuesta-texto" placeholder="Respuesta..."></textarea><button onclick="enviarRespuestaPostventa()" class="action-button action-button-success">Enviar</button></div>
        </div>
    </div>

    <script>
        console.log("[DEBUG] Inicio del bloque <script>");

        // --- Variables Globales y Datos Simulados ---
        let pedidosEmpaquetadosHoyCount = 0;
        window.pedidosDataGlobal = {};
        window.preguntasDataGlobal = [
            { id: "PREG1", itemId: "MLA123", texto: "¿Tienen stock en color azul para el SuperPhone X?", fecha: new Date(Date.now() - 86400000 * 1).toISOString(), unread: true, respondida: false, producto: { nombre: "SuperPhone X - Azul Galaxia", imagen: "https://via.placeholder.com/60/00F/FFF?Text=SPX" } },
            { id: "PREG2", itemId: "MLA456", texto: "¿Hacen envíos a Tierra del Fuego para la Tablet GenPad 5?", fecha: new Date(Date.now() - 86400000 * 2).toISOString(), unread: false, respondida: true, respuesta: "Sí, hacemos envíos a todo el país a través de Mercado Envíos.", producto: { nombre: "Tablet GenPad 5 - Gris Espacial", imagen: "https://via.placeholder.com/60/888/FFF?Text=GP5" } },
            { id: "PREG3", itemId: "MLA789", texto: "¿Cuál es la garantía de los Auriculares SonicBlast? ¿Cubre caídas?", fecha: new Date(Date.now() - 3600000 * 5).toISOString(), unread: true, respondida: false, producto: { nombre: "Auriculares SonicBlast - Negro Mate", imagen: "https://via.placeholder.com/60/222/FFF?Text=SB" } }
        ];
        window.conversacionesDataGlobal = [
            { id: "CONV1", pedidoId: "MELIORDER-FLEX1", clienteNombre: "Juan Flex", ultimoMensaje: "¡Muchas gracias por la rápida respuesta!", fechaUltimoMensaje: new Date(Date.now() - 3600000 * 2).toISOString(), unread: true, mensajes: [ { texto: "¿Podrían confirmar si mi pedido ya fue preparado?", emisor: "cliente", fecha: new Date(Date.now() - 3600000 * 2.5).toISOString()}, { texto: "Hola Juan! Sí, tu pedido MELIORDER-FLEX1 ya está listo para ser despachado con Flex hoy mismo.", emisor: "vendedor", fecha: new Date(Date.now() - 3600000 * 2.2).toISOString() }, { texto: "¡Muchas gracias por la rápida respuesta!", emisor: "cliente", fecha: new Date(Date.now() - 3600000 * 2).toISOString()} ] },
            { id: "CONV2", pedidoId: "MELIORDER-CORREO1", clienteNombre: "Maria Correo", ultimoMensaje: "Ok, aguardo el código de seguimiento. Saludos.", fechaUltimoMensaje: new Date(Date.now() - 86400000 * 1.5).toISOString(), unread: false, mensajes: [ { texto: "Buenas tardes, realicé una compra ayer, ¿cuándo lo despachan?", emisor: "cliente", fecha: new Date(Date.now() - 86400000 * 1.7).toISOString() }, { texto: "Hola Maria, tu pedido MELIORDER-CORREO1 se despacha hoy por la tarde. Te llegará el código de seguimiento automáticamente. Saludos!", emisor: "vendedor", fecha: new Date(Date.now() - 86400000 * 1.6).toISOString() }, { texto: "Ok, aguardo el código de seguimiento. Saludos.", emisor: "cliente", fecha: new Date(Date.now() - 86400000 * 1.5).toISOString() } ] }
        ];
        window.historialPedidosGlobal = {};
        window.devolucionesDataGlobal = [];
        window.empaquetadoresDisponibles = [];
        window.empaquetadorActivo = null;

        window.pedidosCanceladosPorMLSimulado = ['MELIORDER-FLEX1', 'ID-PEDIDO-QUE-NO-EXISTE']; 

        const plantillasRespuesta = [
            { id: "saludo_stock", titulo: "Saludo + Hay Stock", texto: "¡Hola! Gracias por tu consulta. Sí, tenemos stock disponible para entrega inmediata. ¡Esperamos tu compra! Saludos." },
            { id: "despedida_stock", titulo: "Consulta Stock + Despedida", texto: "¡Hola! Sí, tenemos stock. Cualquier otra duda, avísanos. ¡Saludos!"},
            { id: "agradecimiento_compra", titulo: "Agradecimiento Post-Venta", texto: "¡Hola! Muchas gracias por tu compra. Estamos preparando tu pedido y te avisaremos cuando sea despachado. Saludos." },
            { id: "info_envio", titulo: "Info Envío Estándar", texto: "¡Hola! Tu pedido será despachado en las próximas 24hs hábiles. Recibirás el código de seguimiento por este medio y por email. Saludos."},
            { id: "respuesta_generica", titulo: "Respuesta Genérica", texto: "¡Hola! Gracias por comunicarte. Estamos revisando tu consulta y te responderemos a la brevedad. Saludos."}
        ];
        const MOTIVOS_DEVOLUCION = ["No me gustó/No era lo que esperaba", "Talle/Color incorrecto", "Producto defectuoso", "Me arrepentí de la compra", "Dañado en el envío"];
        const ESTADOS_DEVOLUCION = [
            "Iniciada", "En tránsito al vendedor", "Recibida por el vendedor", "Inspección completada",
            "Procesada (Stock Reingresado)", "Procesada (Items Descartados)", 
            "Reembolso procesado", "Cerrada", "Cancelada"
        ];
        const pedidosSimuladosBase = [ 
            {id: 'MELIORDER-TURBO1', cliente: 'Cliente Turbo', itemsCount: 2, tipoEnvio: 'TURBO', esCancelado: false, fechaCancelacion: null, productos: [{img: "https://via.placeholder.com/50/FF00FF/000000?Text=PT1", nombre: "Prod Turbo A", sku: "TUR-A", pedida: 1}, {img: "https://via.placeholder.com/50/FFFF00/000000?Text=PT2", nombre: "Prod Turbo B", sku: "TUR-B", pedida: 1}]},
            {id: 'MELIORDER-FLEX1', cliente: 'Juan Flex', itemsCount: 3, tipoEnvio: 'FLEX', esCancelado: false, fechaCancelacion: null, productos: [{img: "https://via.placeholder.com/50/FF0000/FFFFFF?Text=P1", nombre: "Botella Azul", sku: "BT500-AZUL", pedida: 2, ubicacion: "A1-S3", notaProducto: "Revisar tapa"}, {img: "https://via.placeholder.com/50/00FF00/FFFFFF?Text=P2", nombre: "Taza Gato", sku: "TAZA-CL01", pedida: 1, ubicacion: "B2-S1"}]},
            {id: 'MELIORDER-CORREO1', cliente: 'Maria Correo', itemsCount: 1, tipoEnvio: 'CORREO', esCancelado: false, fechaCancelacion: null, notaInterna: "Revisar dirección de envío antes de imprimir etiqueta.", productos: [{img: "https://via.placeholder.com/50/0000FF/FFFFFF?Text=P3", nombre: "Libreta Ecológica", sku: "LIB-ECO-R", pedida: 1, ubicacion: "D1-S2", notaProducto: "Color verde oscuro"}]},
            {id: 'MELIORDER-RETIRO1', cliente: 'Laura Retira', itemsCount: 1, tipoEnvio: 'RETIRO', esCancelado: false, fechaCancelacion: null, notaInterna: "Llama media hora antes. Paga saldo pendiente.", productos: [{img: "https://via.placeholder.com/50/800080/FFFFFF?Text=PR1", nombre: "Producto para Retiro Especial", sku: "PROD-RET-ESP", pedida: 1, ubicacion: "Mostrador Caja", notaProducto: "Preparar en bolsa especial regalo."}]}
        ];

        console.log("[DEBUG] Variables globales definidas.");

        // --- DEFINICIONES DE FUNCIONES ---

        function mostrarSeccion(idSeccion) {
            // console.log("[DEBUG] mostrarSeccion llamada con:", idSeccion);
            const secciones = ['dashboard-wrapper', 'verificacion-actual-wrapper', 'historial-pedidos', 'preguntas-wrapper', 'mensajes-postventa-wrapper', 'configuracion-wrapper', 'devoluciones-wrapper'];
            secciones.forEach(id => { 
                const el = document.getElementById(id); 
                if (el) {
                    el.style.display = 'none';
                } else {
                    console.warn("[DEBUG] mostrarSeccion: No se encontró el div de sección:", id);
                }
            });
           
            const seccionActiva = document.getElementById(idSeccion);
            if (seccionActiva) {
                seccionActiva.style.display = 'block';
            } else { 
                console.error(`[DEBUG] mostrarSeccion: Elemento ${idSeccion} no encontrado.`); 
                return; 
            }
           
            if (idSeccion === 'dashboard-wrapper') { 
                if (typeof actualizarDashboard === 'function') actualizarDashboard(); else console.error("[DEBUG] actualizarDashboard no es una función");
                if (typeof actualizarInfoEmpaquetadorActivoDashboard === 'function') actualizarInfoEmpaquetadorActivoDashboard(); else console.error("[DEBUG] actualizarInfoEmpaquetadorActivoDashboard no es una función");
                if (typeof checkForRecentCancellations === 'function') checkForRecentCancellations(); else console.error("[DEBUG] checkForRecentCancellations no es una función");
            } else if (idSeccion === 'preguntas-wrapper') { 
                if (typeof cargarPreguntasSinResponder === 'function') cargarPreguntasSinResponder(); else console.error("[DEBUG] cargarPreguntasSinResponder no es una función");
                if (typeof popularSelectsPlantillas === 'function') popularSelectsPlantillas(); else console.error("[DEBUG] popularSelectsPlantillas no es una función");
            } else if (idSeccion === 'mensajes-postventa-wrapper') { 
                if (typeof cargarConversacionesPostventa === 'function') cargarConversacionesPostventa(); else console.error("[DEBUG] cargarConversacionesPostventa no es una función");
                if (typeof popularSelectsPlantillas === 'function') popularSelectsPlantillas(); else console.error("[DEBUG] popularSelectsPlantillas no es una función");
            } else if (idSeccion === 'verificacion-actual-wrapper') { 
                const idPedidoActualEl = document.getElementById('id-pedido-actual');
                const verificacionPedidoEl = document.getElementById('verificacion-pedido');
                if (idPedidoActualEl && verificacionPedidoEl) {
                    verificacionPedidoEl.style.display = idPedidoActualEl.textContent ? 'block' : 'none';
                } else {
                    console.warn("[DEBUG] Elementos id-pedido-actual o verificacion-pedido no encontrados en verificacion-actual-wrapper");
                }
            } else if (idSeccion === 'configuracion-wrapper') { 
                if (typeof popularListaEmpaquetadoresUI === 'function') popularListaEmpaquetadoresUI(); else console.error("[DEBUG] popularListaEmpaquetadoresUI no es una función");
            } else if (idSeccion === 'devoluciones-wrapper') { 
                if (typeof cargarVistaDevoluciones === 'function') cargarVistaDevoluciones(); else console.error("[DEBUG] cargarVistaDevoluciones no es una función");
            }
        }
        console.log("[DEBUG] Función mostrarSeccion definida:", typeof mostrarSeccion);
        
        // ... (AQUÍ VAN TODAS TUS OTRAS FUNCIONES: actualizarDashboard, cargarPreguntasSinResponder, etc.)
        // He omitido el cuerpo de las otras funciones para brevedad, pero deben estar aquí en tu código real.
        // Por favor, asegúrate de que todas tus funciones estén definidas antes del listener de DOMContentLoaded.
        // Ejemplo de cómo deberían seguir las demás funciones:
        function actualizarDashboard() { /* ... tu código ... */ }
        function actualizarInfoEmpaquetadorActivoDashboard() { /* ... tu código ... */ }
        function checkForRecentCancellations() { /* ... tu código ... */ }
        function actualizarBadgeNotificaciones(badgeId) { /* ... tu código ... */ }
        function agregarEmpaquetador() { /* ... tu código ... */ }
        function eliminarEmpaquetador(nombreAEliminar) { /* ... tu código ... */ }
        function popularListaEmpaquetadoresUI() { /* ... tu código ... */ }
        function seleccionarEmpaquetadorActivo(nombre) { /* ... tu código ... */ }
        function guardarConfiguracionEmpaquetadores() { /* ... tu código ... */ }
        function cargarConfiguracionEmpaquetadores() { /* ... tu código ... */ }
        function popularListasDePedidosPendientes() { /* ... tu código ... */ }
        function cargarPedido(idPedido) { /* ... tu código ... */ }
        function verificarItemConClick(boton, itemIdInstanciaPedido) { /* ... tu código ... */ }
        function actualizarProgresoGeneral() { /* ... tu código ... */ }
        function guardarNotaInterna() { /* ... tu código ... */ }
        function guardarPedidosDataGlobal() { /* ... tu código ... */ }
        function guardarHistorialPedidosGlobal() { /* ... tu código ... */ }
        function finalizarPedidoActual() { /* ... tu código ... */ }
        function actualizarMensajeListaVacia(listId) { /* ... tu código ... */ }
        function popularSelectsPlantillas() { /* ... tu código ... */ }
        function aplicarPlantilla(selectElement, textareaId) { /* ... tu código ... */ }
        function cargarPreguntasSinResponder() { /* ... tu código ... */ }
        function toggleLeidoPregunta(idPregunta, boton) { /* ... tu código ... */ }
        function responderPregunta(idPregunta) { /* ... tu código ... */ }
        function filtrarListaPreguntas() { /* ... tu código ... */ }
        function cargarConversacionesPostventa() { /* ... tu código ... */ }
        function toggleLeidoConversacion(idConversacion, marcarComoLeido) { /* ... tu código ... */ }
        let conversacionActivaIdModal = null;
        function abrirModalMensajesPostventa(idConversacion) { /* ... tu código ... */ }
        function renderizarMensajesPostventa(idConv, mensajes) { /* ... tu código ... */ }
        function cerrarModalMensajesPostventa() { /* ... tu código ... */ }
        function enviarRespuestaPostventa() { /* ... tu código ... */ }
        function inicializarDatosDevoluciones() { /* ... tu código ... */ }
        function guardarDatosDevoluciones() { /* ... tu código ... */ }
        function cargarVistaDevoluciones() { /* ... tu código ... */ }
        function cambiarEstadoDevolucion(devolucionId, nuevoEstado) { /* ... tu código ... */ }
        function reingresarStockDevolucion(devolucionId) { /* ... tu código ... */ }
        function descartarProductosDevolucion(devolucionId) { /* ... tu código ... */ }
        function sincronizarCancelacionesConML() { /* ... tu código ... */ }
        function cargarHistorial() { /* ... tu código ... */ }
        function verDetallesPedidoHistorial(fecha, idPedido) { /* ... tu código ... */ }
        function mostrarResumenProductosDia() { /* ... tu código ... */ }

        console.log("[DEBUG] Todas las demás funciones (supuestamente) definidas.");

        // --- Inicialización al cargar la página ---
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log("[DEBUG] DOMContentLoaded evento disparado.");
            try {
                const elFechaHistorial = document.getElementById('fecha-historial');
                if (elFechaHistorial) {
                    const today = new Date();
                    elFechaHistorial.value = `${today.getFullYear()}-${('0' + (today.getMonth() + 1)).slice(-2)}-${('0' + today.getDate()).slice(-2)}`;
                } else {
                    console.warn("[DEBUG] Elemento fecha-historial no encontrado en DOMContentLoaded.");
                }
                
                const historialGuardado = localStorage.getItem('historialPedidosGlobal');
                if (historialGuardado) {
                    try {
                        window.historialPedidosGlobal = JSON.parse(historialGuardado);
                    } catch (e) {
                        console.error("[DEBUG] Error parseando historialPedidosGlobal desde localStorage:", e);
                        window.historialPedidosGlobal = {};
                    }
                }
            
                const pedidosGuardadosLocal = localStorage.getItem('pedidosDataGlobal');
                if (pedidosGuardadosLocal) { 
                    try {
                        window.pedidosDataGlobal = JSON.parse(pedidosGuardadosLocal);
                        Object.values(window.pedidosDataGlobal).forEach(p => {
                            if (p.esCancelado === undefined) p.esCancelado = false;
                            if (p.fechaCancelacion === undefined) p.fechaCancelacion = null;
                        });
                    } catch (e) {
                        console.error("[DEBUG] Error parseando pedidosDataGlobal desde localStorage:", e);
                        window.pedidosDataGlobal = {}; //Fallback a objeto vacío
                        // Re-inicializar con datos base si el parseo falla y es la primera carga
                        pedidosSimuladosBase.forEach(p => {
                            p.productos.forEach(prod => prod.verificada = 0); 
                            window.pedidosDataGlobal[p.id] = JSON.parse(JSON.stringify({ 
                                ...p, empaquetado: false, fechaCompletado: null, empaquetadoPor: null, 
                                stockDescontadoConfirmado: false, esCancelado: p.esCancelado || false, 
                                fechaCancelacion: p.fechaCancelacion || null 
                            }));
                        });
                        if (typeof guardarPedidosDataGlobal === 'function') guardarPedidosDataGlobal();
                    }
                } else {
                     pedidosSimuladosBase.forEach(p => {
                        p.productos.forEach(prod => prod.verificada = 0); 
                        window.pedidosDataGlobal[p.id] = JSON.parse(JSON.stringify({ 
                            ...p, empaquetado: false, fechaCompletado: null, empaquetadoPor: null, 
                            stockDescontadoConfirmado: false, esCancelado: p.esCancelado || false, 
                            fechaCancelacion: p.fechaCancelacion || null 
                        }));
                    });
                    if (typeof guardarPedidosDataGlobal === 'function') guardarPedidosDataGlobal();
                }

                if (window.historialPedidosGlobal && typeof window.historialPedidosGlobal === 'object') {
                    for (const fecha in window.historialPedidosGlobal) {
                        if(Array.isArray(window.historialPedidosGlobal[fecha])) {
                            window.historialPedidosGlobal[fecha].forEach(p => {
                                if (p.esCancelado === undefined) p.esCancelado = false;
                                if (p.fechaCancelacion === undefined) p.fechaCancelacion = null;
                            });
                        }
                    }
                }


                if (typeof cargarConfiguracionEmpaquetadores === 'function') cargarConfiguracionEmpaquetadores(); else console.error("[DEBUG] cargarConfiguracionEmpaquetadores no es una función");
                if (typeof inicializarDatosDevoluciones === 'function') inicializarDatosDevoluciones(); else console.error("[DEBUG] inicializarDatosDevoluciones no es una función");
                if (typeof popularListasDePedidosPendientes === 'function') popularListasDePedidosPendientes(); else console.error("[DEBUG] popularListasDePedidosPendientes no es una función");
                if (typeof popularSelectsPlantillas === 'function') popularSelectsPlantillas(); else console.error("[DEBUG] popularSelectsPlantillas no es una función");
                if (typeof cargarPreguntasSinResponder === 'function') cargarPreguntasSinResponder(); else console.error("[DEBUG] cargarPreguntasSinResponder no es una función");
                if (typeof cargarConversacionesPostventa === 'function') cargarConversacionesPostventa(); else console.error("[DEBUG] cargarConversacionesPostventa no es una función");
            
                console.log("[DEBUG] Llamando a mostrarSeccion('dashboard-wrapper') desde DOMContentLoaded.");
                if (typeof mostrarSeccion === 'function') {
                    mostrarSeccion('dashboard-wrapper'); 
                } else {
                    console.error("[DEBUG] ERROR CRÍTICO: mostrarSeccion no es una función al intentar llamarla desde DOMContentLoaded.");
                }
                console.log("[DEBUG] mostrarSeccion llamada desde DOMContentLoaded completada (o intento realizado).");

                const completarEmpaqueBtn = document.getElementById('completar-empaque-btn');
                if (completarEmpaqueBtn && typeof finalizarPedidoActual === 'function') {
                    completarEmpaqueBtn.addEventListener('click', finalizarPedidoActual);
                } else {
                     if(!completarEmpaqueBtn) console.warn("[DEBUG] Botón completar-empaque-btn no encontrado.");
                     if(typeof finalizarPedidoActual !== 'function') console.error("[DEBUG] finalizarPedidoActual no es una función.");
                }

                const filtroPreguntasInput = document.getElementById('filtro-preguntas');
                if (filtroPreguntasInput && typeof filtrarListaPreguntas === 'function') {
                    filtroPreguntasInput.addEventListener('input', filtrarListaPreguntas);
                } else {
                     if(!filtroPreguntasInput) console.warn("[DEBUG] Input filtro-preguntas no encontrado.");
                     if(typeof filtrarListaPreguntas !== 'function') console.error("[DEBUG] filtrarListaPreguntas no es una función.");
                }
                
                const barcodeScannerInput = document.getElementById('barcode-scanner');
                if (barcodeScannerInput) {
                    barcodeScannerInput.addEventListener('keypress', function(e) { 
                         if (e.key === 'Enter') {
                            e.preventDefault();
                            const scannedValue = this.value.trim().toUpperCase();
                            if (scannedValue === "") return;
                            const idPedidoActualEl = document.getElementById('id-pedido-actual');
                            const idPedidoActual = idPedidoActualEl ? idPedidoActualEl.textContent : null;

                            if (!idPedidoActual || !window.pedidosDataGlobal || !window.pedidosDataGlobal[idPedidoActual]) {
                                 alert("No hay pedido activo para escanear productos."); this.value = ''; return;
                            }
                            const pedido = window.pedidosDataGlobal[idPedidoActual];
                            if (!pedido || !Array.isArray(pedido.productos)) {
                                alert("Datos del pedido o productos no encontrados/inválidos."); this.value = ''; return;
                            }
                            const productoEncontrado = pedido.productos.find(p => p.sku && p.sku.toUpperCase() === scannedValue && (p.verificada || 0) < p.pedida);
                            if (productoEncontrado) {
                                const filaProducto = document.querySelector(`#tabla-productos-tbody tr[data-item-id="${productoEncontrado.id_instancia_pedido}"]`);
                                if (filaProducto) {
                                    const botonVerificar = filaProducto.querySelector('button.action-button:not(:disabled)');
                                    if (botonVerificar && typeof verificarItemConClick === 'function') {
                                        verificarItemConClick(botonVerificar, productoEncontrado.id_instancia_pedido);
                                    } else {
                                        console.warn(`[DEBUG] Producto ${productoEncontrado.nombre} (SKU: ${scannedValue}) encontrado, pero su botón de verificación no está activo o no se encontró, o verificarItemConClick no es función.`);
                                        alert(`El producto ${productoEncontrado.nombre} (SKU: ${scannedValue}) ya ha sido completamente verificado o hay un problema con su botón/función de verificación.`);
                                    }
                                } else {
                                     console.error(`[DEBUG] No se encontró la fila para el producto con id_instancia_pedido: ${productoEncontrado.id_instancia_pedido} (SKU: ${scannedValue})`);
                                     alert(`Se encontró el producto con SKU ${scannedValue} pero no su fila en la tabla.`);
                                }
                            } else {
                                alert(`SKU "${scannedValue}" no encontrado en este pedido, o ya ha sido completamente verificado.`);
                            }
                            this.value = ''; this.focus();
                        }
                    });
                } else {
                    console.warn("[DEBUG] Input barcode-scanner no encontrado.");
                }

            } catch (e) {
                console.error("[DEBUG] Error durante la inicialización en DOMContentLoaded:", e.message, e.stack);
            }
            
            console.log("[DEBUG] Sistema de Verificación de Empaques y Gestión ML inicializado (final de DOMContentLoaded).");
        });
        console.log("[DEBUG] Fin del bloque <script>, listener de DOMContentLoaded añadido.");
    </script>
</body>
</html>